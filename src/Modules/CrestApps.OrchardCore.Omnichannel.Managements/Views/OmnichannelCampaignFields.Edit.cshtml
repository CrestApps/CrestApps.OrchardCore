@using CrestApps.OrchardCore.Omnichannel.Core.Models
@using CrestApps.OrchardCore.Omnichannel.Managements.ViewModels
@using OrchardCore
@using CrestApps.OrchardCore.AI.Core

@model OmnichannelCampaignViewModel

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="DisplayText" class="@Orchard.GetLabelClasses()">@T["Name"]</label>
    <div class="@Orchard.GetEndClasses()">
        <input asp-for="DisplayText" class="form-control" />
        <span asp-validation-for="DisplayText" class="text-danger"></span>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="Description" class="@Orchard.GetLabelClasses()">@T["Description"]</label>
    <div class="@Orchard.GetEndClasses()">
        <textarea asp-for="Description" class="form-control"></textarea>
        <span asp-validation-for="Description" class="text-danger"></span>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="InteractionType" class="@Orchard.GetLabelClasses()">@T["Interaction type"]</label>
    <div class="@Orchard.GetEndClasses()">
        <select asp-for="InteractionType" asp-items="Model.InteractionTypes" class="form-select"></select>
        <span asp-validation-for="InteractionType" class="text-danger"></span>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="Channel" class="@Orchard.GetLabelClasses()">@T["Channel"]</label>
    <div class="@Orchard.GetEndClasses()">
        <select asp-for="Channel" asp-items="Model.Channels" class="form-select"></select>
        <span asp-validation-for="Channel" class="text-danger"></span>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label class="@Orchard.GetLabelClasses()">@T["Dispositions"]</label>
    <div class="@Orchard.GetEndClasses()">
        @for (var i = 0; i < Model.Dispositions.Length; i++)
        {
            var disposition = Model.Dispositions[i];
            var htmlId = Html.IdFor(m => m.Dispositions[i].Selected);

            <div class="form-check">
                <input type="hidden" asp-for="Dispositions[i].Value" />
                <input type="checkbox" asp-for="Dispositions[i].Selected" id="@htmlId" class="form-check-input" />
                <label for="@htmlId" class="form-check-label">
                    @disposition.Text
                </label>
            </div>
        }
    </div>
</div>

<div class="@Orchard.GetWrapperClasses("automated-interaction-type", Model.InteractionType == ActivityInteractionType.Manual ? "d-none" : string.Empty)">
    <label asp-for="ChannelEndpointId" class="@Orchard.GetLabelClasses()">@T["Channel endpoint"]</label>
    <div class="@Orchard.GetEndClasses()">
        <select asp-for="ChannelEndpointId" asp-items="Model.ChannelEndpoints" class="form-select">
            <option value="">@T["Select an endpoint"]</option>
        </select>
        <span asp-validation-for="ChannelEndpointId" class="text-danger"></span>
        <span class="hint">@T["Specifies the endpoint to use when sending a response to the incoming message."]</span>
    </div>
</div>

<div class="automated-interaction-type @(Model.InteractionType == ActivityInteractionType.Manual ? "d-none" : string.Empty)">
    <h4 class="border-bottom pb-2 mt-4">@T["AI configuration"]</h4>

    <div class="mb-3" asp-validation-class-for="ProviderName">
        <label asp-for="ProviderName" class="form-label">@T["Provider"]</label>
        <select asp-for="ProviderName" class="form-select" asp-items="Model.Providers">
            <option value="">@T["Select a provider"]</option>
        </select>
        <span asp-validation-for="ProviderName"></span>
    </div>

    <div class="mb-3" asp-validation-class-for="ConnectionName">
        <label asp-for="ConnectionName" class="form-label">@T["Connection"]</label>
        <select asp-for="ConnectionName" class="form-select" asp-items="Model.ConnectionNames">
            <option value="">@T["Default connection"]</option>
        </select>
        <span asp-validation-for="ConnectionName"></span>
    </div>

    <div class="mb-3" asp-validation-class-for="DeploymentName">
        <label asp-for="DeploymentName" class="form-label">@T["Deployment"]</label>
        <select asp-for="DeploymentName" class="form-select" asp-items="Model.DeploymentNames">
            <option value="">@T["Default deployment"]</option>
        </select>
        <span asp-validation-for="DeploymentName"></span>
    </div>

    <div class="@Orchard.GetWrapperClasses("automated-interaction-type", Model.InteractionType == ActivityInteractionType.Manual ? "d-none" : string.Empty)">
        <label asp-for="InitialOutboundPromptPattern" class="@Orchard.GetLabelClasses()">@T["Initial outbound prompt pattern"]</label>
        <div class="@Orchard.GetEndClasses()">
            <textarea asp-for="InitialOutboundPromptPattern" rows="5" class="form-control"></textarea>
            <span class="hint">@T["This is the first message sent to the contact to initiate the conversation. Supports Liquid syntax. You can use the following variables to generate the message: <code>{0}</code>, <code>{1}</code>, <code>{2}</code>, and <code>{3}</code>.", "Contact", "Campaign", "Profile", "Session"]</span>
            <span asp-validation-for="InitialOutboundPromptPattern" class="text-danger"></span>
        </div>
    </div>

    <div class="@Orchard.GetWrapperClasses("automated-interaction-type", Model.InteractionType == ActivityInteractionType.Manual ? "d-none" : string.Empty)">
        <label asp-for="CampaignGoal" class="@Orchard.GetLabelClasses()">@T["Campaign goal"]</label>
        <div class="@Orchard.GetEndClasses()">
            <textarea asp-for="CampaignGoal" rows="3" class="form-control"></textarea>
            <span asp-validation-for="CampaignGoal" class="text-danger"></span>
            <span class="hint">@T["Describe the goal of this campaign. The AI uses this to determine when to disposition the activity and end the converation."]</span>
        </div>
    </div>

    <div class="@Orchard.GetWrapperClasses()">
        <label asp-for="SystemMessage" class="@Orchard.GetLabelClasses()">@T["System instructions"]</label>
        <div class="@Orchard.GetEndClasses()">
            <div class="hint mb-1">@T["Set the AI's behavior and response style."]</div>
            <textarea asp-for="SystemMessage" class="form-control content-preview-text" rows="5"></textarea>
        </div>
    </div>

    <div class="@Orchard.GetWrapperClasses()">
        <label asp-for="MaxTokens" class="@Orchard.GetLabelClasses()">@T["Max response"]</label>
        <div class="@Orchard.GetEndClasses()">
            <input type="number" class="form-control" asp-for="MaxTokens" step="4" min="4">
        </div>
    </div>

    <div class="@Orchard.GetWrapperClasses()">
        <label asp-for="Temperature" class="@Orchard.GetLabelClasses()">@T["Temperature"]</label>
        <div class="@Orchard.GetEndClasses()">
            <input type="number" class="form-control" asp-for="Temperature" step="0.01" min="0" max="1">
        </div>
    </div>

    <div class="@Orchard.GetWrapperClasses()">
        <label asp-for="TopP" class="@Orchard.GetLabelClasses()">@T["Top P"]</label>
        <div class="@Orchard.GetEndClasses()">
            <input type="number" class="form-control" asp-for="TopP" step="0.01" min="0" max="1">
        </div>
    </div>

    <div class="@Orchard.GetWrapperClasses()">
        <label asp-for="FrequencyPenalty" class="@Orchard.GetLabelClasses()">@T["Frequency penalty"]</label>
        <div class="@Orchard.GetEndClasses()">
            <input type="number" class="form-control" asp-for="FrequencyPenalty" step="0.01" min="0" max="1">
        </div>
    </div>

    <div class="@Orchard.GetWrapperClasses()">
        <label asp-for="PresencePenalty" class="@Orchard.GetLabelClasses()">@T["Presence penalty"]</label>
        <div class="@Orchard.GetEndClasses()">
            <input type="number" class="form-control" asp-for="PresencePenalty" step="0.01" min="0" max="1">
        </div>
    </div>

    <div class="@Orchard.GetWrapperClasses()">
        <label class="@Orchard.GetLabelClasses()">@T["Permissions"]</label>
        <div class="@Orchard.GetEndClasses()">
            <div class="form-check">
                <input asp-for="AllowAIToUpdateContact" class="form-check-input" type="checkbox" id="@Html.IdFor(x => x.AllowAIToUpdateContact)" />
                <label class="form-check-label" for="@Html.IdFor(x => x.AllowAIToUpdateContact)">
                    @T["Allow AI to update the contact"]
                </label>
            </div>
            <div class="form-check">
                <input asp-for="AllowAIToUpdateSubject" class="form-check-input" type="checkbox" id="@Html.IdFor(x => x.AllowAIToUpdateSubject)" />
                <label class="form-check-label" for="@Html.IdFor(x => x.AllowAIToUpdateSubject)">
                    @T["Allow AI to update the subject/title"]
                </label>
            </div>
        </div>
    </div>

    @if (Model.Tools is not null && Model.Tools.Count > 0)
    {
        <h4 class="border-bottom pb-2 mt-4">@T["System Defined Tools"]</h4>
        <div class="mb-3">
            @foreach (var tools in Model.Tools)
            {
                var groupKey = tools.Key;
                var groupId = groupKey.Replace(" ", "-");
                <div class="mb-3">
                    <h5>@groupKey</h5>
                    <div class="form-check">
                        <input class="form-check-input group-toggle" type="checkbox" id="selectAll_@groupId" data-group="@groupId" />
                        <label class="form-check-label" for="selectAll_@groupId">
                            @T["Select All item in {0}", groupKey]
                        </label>
                    </div>
                    <div class="ms-3">
                        @for (var i = 0; i < tools.Value.Length; i++)
                        {
                            <div class="form-check">
                                <input type="hidden" asp-for="@Model.Tools[groupKey][i].ItemId" />
                                <input asp-for="@Model.Tools[groupKey][i].IsSelected" type="checkbox" class="form-check-input group-checkbox" data-group="@groupId" id="tool_@(groupId)_@i" />
                                <label class="form-check-label" asp-for="@Model.Tools[groupKey][i].IsSelected">
                                    @tools.Value[i].DisplayText
                                </label>
                                <span class="hint dashed">@tools.Value[i].Description</span>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

<style asp-name="codemirror"></style>
<script asp-name="codemirror" at="Foot"></script>
<script asp-name="codemirror-mode-javascript" at="Foot"></script>
<script asp-name="codemirror-addon-display-autorefresh" at="Foot"></script>
<script asp-name="codemirror-addon-mode-simple" at="Foot"></script>
<script asp-name="codemirror-addon-mode-multiplex" at="Foot"></script>
<script asp-name="codemirror-mode-xml" at="Foot"></script>
<script asp-src="~/OrchardCore.Liquid/codemirror/liquid.js" at="Foot"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const outboundEl = document.getElementById('@Html.IdFor(x => x.InitialOutboundPromptPattern)');
        if (outboundEl) {
            CodeMirror.fromTextArea(outboundEl, {
                autoRefresh: true,
                lineNumbers: true,
                styleActiveLine: true,
                matchBrackets: true,
                mode: { name: "liquid" },
            });
        }

        const interactionTypeSelect = document.getElementById("@Html.IdFor(x => x.InteractionType)");

        function toggleInteractionTypeFields() {
            const value = interactionTypeSelect.value;
            const automatedEls = document.querySelectorAll(".automated-interaction-type");
            const manualEls = document.querySelectorAll(".manual-interaction-type");

            if (value === "@nameof(ActivityInteractionType.Automated)") {
                automatedEls.forEach(el => el.classList.remove("d-none"));
                manualEls.forEach(el => el.classList.add("d-none"));
            } else if (value === "@nameof(ActivityInteractionType.Manual)") {
                automatedEls.forEach(el => el.classList.add("d-none"));
                manualEls.forEach(el => el.classList.remove("d-none"));
            } else {
                automatedEls.forEach(el => el.classList.add("d-none"));
                manualEls.forEach(el => el.classList.add("d-none"));
            }
        }

        // Run once on load to set initial state
        toggleInteractionTypeFields();

        // Listen for changes
        interactionTypeSelect.addEventListener("change", toggleInteractionTypeFields);

        // Tools group selection
        document.querySelectorAll('.group-toggle').forEach(toggle => {
            toggle.addEventListener('change', function () {
                const groupName = this.dataset.group;
                const checkboxes = document.querySelectorAll(`.group-checkbox[data-group="${groupName}"]`);
                checkboxes.forEach(cb => cb.checked = this.checked);
            });
        });

        document.querySelectorAll('.group-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const groupName = this.dataset.group;
                const all = document.querySelectorAll(`.group-checkbox[data-group="${groupName}"]`);
                const allChecked = [...all].every(cb => cb.checked);
                const toggle = document.querySelector(`.group-toggle[data-group="${groupName}"]`);
                if (toggle) toggle.checked = allChecked;
            });
        });

        // Provider -> connections -> deployments
        const providerElement = document.getElementById('@Html.IdFor(m => m.ProviderName)');
        const connectionElement = document.getElementById('@Html.IdFor(m => m.ConnectionName)');
        const deploymentElement = document.getElementById('@Html.IdFor(m => m.DeploymentName)');

        if (providerElement && connectionElement && deploymentElement) {
            const connectionContainer = connectionElement.closest('.mb-3');
            const deploymentContainer = deploymentElement.closest('.mb-3');

            if (connectionContainer) connectionContainer.style.display = 'none';
            if (deploymentContainer) deploymentContainer.style.display = 'none';

            const providerNameInitial = '@(Model.ProviderName ?? "")';
            const connectionInitial = '@(Model.ConnectionName ?? "")';
            const deploymentInitial = '@(Model.DeploymentName ?? "")';

            async function fetchConnections(providerName) {
                [...connectionElement.options].forEach(option => { if (option.value) option.remove(); });
                [...deploymentElement.options].forEach(option => { if (option.value) option.remove(); });

                if (!providerName) { connectionElement.value = ''; return; }

                var url = '@(Url.RouteUrl(AIConstants.RouteNames.GetConnectionsByProviderRouteName))';
                try {
                    const response = await fetch(`${url}?providerName=${encodeURIComponent(providerName)}`);
                    if (!response.ok) throw new Error('Failed to fetch connections');
                    const connections = await response.json();

                    if (connectionContainer) connectionContainer.style.display = '';
                    if (deploymentContainer) deploymentContainer.style.display = '';

                    if (connections && connections.length) {
                        connections.forEach(connection => {
                            let option = document.createElement('option');
                            option.value = connection.id;
                            option.textContent = connection.name;
                            connectionElement.appendChild(option);
                        });
                        if (connectionInitial) {
                            connectionElement.value = connectionInitial;
                            await fetchDeployments(providerName, connectionInitial);
                        }
                    } else {
                        if (connectionContainer) connectionContainer.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error fetching connections:', error);
                }
            }

            async function fetchDeployments(providerName, connection) {
                [...deploymentElement.options].forEach(option => { if (option.value) option.remove(); });
                if (!connection) {
                    deploymentElement.value = '';
                    if (!providerElement.value) {
                        if (deploymentContainer) deploymentContainer.style.display = 'none';
                    } else {
                        if (deploymentContainer) deploymentContainer.style.display = '';
                    }
                    return;
                }
                var url = '@(Url.RouteUrl(AIConstants.RouteNames.GetDeploymentsByConnectionRouteName))';
                try {
                    const response = await fetch(`${url}?providerName=${encodeURIComponent(providerName)}&connection=${encodeURIComponent(connection)}`);
                    if (!response.ok) throw new Error('Failed to fetch deployments');
                    const deployments = await response.json();

                    if (deployments && deployments.length) {
                        deployments.forEach(deployment => {
                            let option = document.createElement('option');
                            option.value = deployment.id;
                            option.textContent = deployment.name;
                            deploymentElement.appendChild(option);
                        });
                        if (deploymentContainer) deploymentContainer.style.display = '';
                        if (deploymentInitial) deploymentElement.value = deploymentInitial;
                    } else {
                        if (deploymentContainer) deploymentContainer.style.display = '';
                    }
                } catch (error) {
                    console.error('Error fetching deployments:', error);
                }
            }

            providerElement.addEventListener('change', async () => {
                await fetchConnections(providerElement.value);
            });
            connectionElement.addEventListener('change', async () => {
                await fetchDeployments(providerElement.value, connectionElement.value);
            });

            if (providerNameInitial) {
                fetchConnections(providerNameInitial);
            }
        }
    });
</script>
