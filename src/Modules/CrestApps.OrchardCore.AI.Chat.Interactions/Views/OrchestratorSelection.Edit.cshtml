@using CrestApps.OrchardCore.AI.Chat.Interactions.ViewModels
@using CrestApps.OrchardCore.AI.Core.Orchestration

@model OrchestratorViewModel

@if (Model.Orchestrators?.Count > 1)
{
    <div class="mb-3">
        <label asp-for="OrchestratorName" class="form-label">
            @T["Orchestrator"]
            <span class="text-muted" data-bs-toggle="tooltip" title="@T["The orchestrator to use for this chat interaction. The orchestrator controls how tools are selected and how the AI execution loop is managed."]">
                <i class="fa-solid fa-circle-question" aria-hidden="true"></i>
            </span>
        </label>
        <select asp-for="OrchestratorName" asp-items="Model.Orchestrators" class="form-select">
        </select>
        <span asp-validation-for="OrchestratorName" class="text-danger"></span>
    </div>
}
else
{
    <input type="hidden" asp-for="OrchestratorName" />
}

<script at="Foot">
    document.addEventListener('DOMContentLoaded', function () {

        const orchestratorSelector = document.getElementById('@Html.IdFor(m => m.OrchestratorName)');
        const defaultOrchestrator = '@(DefaultOrchestrator.OrchestratorName)';

        if (!orchestratorSelector) return;

        function updateFieldVisibility() {

            const selectedOrchestrator =
                orchestratorSelector.value || defaultOrchestrator;

            const elements = document.getElementsByClassName('orchestrator-dependent');
            const targetClass = 'orchestrator-dependent-' + selectedOrchestrator;

            for (const el of elements) {
                el.classList.toggle(
                    'd-none',
                    !el.classList.contains(targetClass)
                );
            }
        }

        if (!orchestratorSelector.value) {
            orchestratorSelector.value = defaultOrchestrator;
        }

        // Initial render
        updateFieldVisibility();

        // React to user changes
        orchestratorSelector.addEventListener('change', function () {
            updateFieldVisibility();

            // Dispatch custom event so dependent views (e.g., Copilot) can react.
            document.dispatchEvent(new CustomEvent('orchestrator-changed', {
                detail: { 
                    orchestrator: orchestratorSelector.value || defaultOrchestrator 
                }
            }));
        });
    });
</script>