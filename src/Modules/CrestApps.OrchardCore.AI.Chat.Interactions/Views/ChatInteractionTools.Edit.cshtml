@using CrestApps.OrchardCore.AI.Chat.Interactions.ViewModels
@using OrchardCore

@model EditChatInteractionToolsViewModel

<div class="mb-3">

    <h5 class="border-bottom pb-2">@T["Tools"]</h5>

    <div class="mb-3">
        <input type="text"
               class="form-control form-control-sm tool-search-input"
               placeholder="@T["Search tools..."]"
               aria-label="@T["Search tools"]" />
    </div>

    <div class="form-check mb-2">
        <input class="form-check-input global-tool-toggle"
               type="checkbox"
               id="selectAllTools" />
        <label class="form-check-label fw-semibold" for="selectAllTools">
            @T["Select All Tools"]
        </label>
    </div>

    <div class="tool-groups-container">
        @foreach (var tools in Model.Tools)
        {
            var groupKey = tools.Key;
            var groupId = groupKey.Replace(" ", "-");

            <div class="mb-3 tool-group" data-group-name="@groupKey">

                <h6>@groupKey</h6>

                <div class="form-check">
                    <input class="form-check-input group-toggle"
                           type="checkbox"
                           id="selectAll_@groupId"
                           data-group="@groupId" />
                    <label class="form-check-label" for="selectAll_@groupId">
                        @T["Select All"]
                    </label>
                </div>

                <div class="ms-3">
                    @for (var i = 0; i < tools.Value.Length; i++)
                    {
                        <div class="form-check tool-item" data-tool-name="@tools.Value[i].DisplayText" data-tool-description="@tools.Value[i].Description">
                            <input type="hidden" asp-for="@Model.Tools[groupKey][i].ItemId" />
                            <input asp-for="@Model.Tools[groupKey][i].IsSelected"
                                   type="checkbox"
                                   class="form-check-input group-checkbox"
                                   data-group="@groupId"
                                   id="tool_@(groupId)_@i" />

                            <label class="form-check-label"
                                   asp-for="@Model.Tools[groupKey][i].IsSelected">
                                @tools.Value[i].DisplayText
                            </label>
                            <span class="hint dashed small">@tools.Value[i].Description</span>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <div class="tool-no-results text-muted small d-none">@T["No tools match your search."]</div>
</div>

<script at="Foot">
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.querySelector('.tool-groups-container');
        if (!container) return;

        const searchInput = document.querySelector('.tool-search-input');
        const globalToggle = document.querySelector('.global-tool-toggle');
        const noResults = document.querySelector('.tool-no-results');

        function updateGroupToggle(groupName) {
            const all = container.querySelectorAll(`.group-checkbox[data-group="${groupName}"]`);
            const visible = [...all].filter(cb => !cb.closest('.tool-item')?.classList.contains('d-none'));
            const allChecked = visible.length > 0 && visible.every(cb => cb.checked);
            const toggle = container.querySelector(`.group-toggle[data-group="${groupName}"]`);
            if (toggle) toggle.checked = allChecked;
        }

        function updateGlobalToggle() {
            const allVisible = [...container.querySelectorAll('.group-checkbox')].filter(cb => !cb.closest('.tool-item')?.classList.contains('d-none'));
            globalToggle.checked = allVisible.length > 0 && allVisible.every(cb => cb.checked);
        }

        let bulkUpdating = false;

        // Group "Select All" toggle.
        container.querySelectorAll('.group-toggle').forEach(toggle => {
            toggle.addEventListener('change', function () {
                bulkUpdating = true;
                const checked = this.checked;
                const checkboxes = container.querySelectorAll(`.group-checkbox[data-group="${this.dataset.group}"]`);
                checkboxes.forEach(cb => {
                    if (!cb.closest('.tool-item')?.classList.contains('d-none')) {
                        cb.checked = checked;
                        cb.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                });
                bulkUpdating = false;
                updateGlobalToggle();
            });
        });

        // Individual checkbox change.
        container.querySelectorAll('.group-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                if (bulkUpdating) return;
                updateGroupToggle(this.dataset.group);
                updateGlobalToggle();
            });
        });

        // Global "Select All Tools" toggle.
        if (globalToggle) {
            globalToggle.addEventListener('change', function () {
                bulkUpdating = true;
                const checked = this.checked;
                container.querySelectorAll('.group-checkbox').forEach(cb => {
                    if (!cb.closest('.tool-item')?.classList.contains('d-none')) {
                        cb.checked = checked;
                        cb.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                });
                container.querySelectorAll('.group-toggle').forEach(t => {
                    if (!t.closest('.tool-group')?.classList.contains('d-none')) {
                        t.checked = checked;
                    }
                });
                bulkUpdating = false;
            });
        }

        // Search filter.
        if (searchInput) {
            searchInput.addEventListener('input', function () {
                const query = this.value.trim().toLowerCase();
                let anyVisible = false;

                container.querySelectorAll('.tool-group').forEach(group => {
                    let groupHasVisible = false;

                    group.querySelectorAll('.tool-item').forEach(item => {
                        const name = (item.dataset.toolName || '').toLowerCase();
                        const desc = (item.dataset.toolDescription || '').toLowerCase();
                        const match = !query || name.includes(query) || desc.includes(query);
                        item.classList.toggle('d-none', !match);
                        if (match) groupHasVisible = true;
                    });

                    group.classList.toggle('d-none', !groupHasVisible);
                    if (groupHasVisible) anyVisible = true;

                    // Update group toggle state for visible items.
                    const groupId = group.querySelector('.group-toggle')?.dataset.group;
                    if (groupId) updateGroupToggle(groupId);
                });

                if (noResults) noResults.classList.toggle('d-none', anyVisible);
                updateGlobalToggle();
            });
        }

        // Set initial toggle states.
        container.querySelectorAll('.group-toggle').forEach(t => updateGroupToggle(t.dataset.group));
        updateGlobalToggle();
    });
</script>
