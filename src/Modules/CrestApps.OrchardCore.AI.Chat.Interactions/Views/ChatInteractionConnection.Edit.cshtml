@using CrestApps.OrchardCore.AI.Chat.Interactions.ViewModels
@using CrestApps.OrchardCore.AI.Core
@using OrchardCore

@model EditChatInteractionConnectionViewModel

@if (Model.Orchestrators?.Count > 1)
{
    <div class="mb-3">
        <label asp-for="OrchestratorName" class="form-label">
            @T["Orchestrator"]
            <span class="text-muted" data-bs-toggle="tooltip" title="@T["The orchestrator to use for this chat interaction. The orchestrator controls how tools are selected and how the AI execution loop is managed."]">
                <i class="fa-solid fa-circle-question" aria-hidden="true"></i>
            </span>
        </label>
        <select asp-for="OrchestratorName" asp-items="Model.Orchestrators" class="form-select" id="ci-orchestrator-selector">
        </select>
        <span asp-validation-for="OrchestratorName" class="text-danger"></span>
    </div>
}
else
{
    <input type="hidden" asp-for="OrchestratorName" />
}

@if (Model.ConnectionNames?.Count > 1)
{
    <div class="mb-3" data-orchestrator-field="connection">
        <label asp-for="ConnectionName" class="form-label">
            @T["Connection"]
            <span class="text-muted" data-bs-toggle="tooltip" title="@T["The connection to use for this chat interaction. If not selected, the default connection will be used."]">
                <i class="fa-solid fa-circle-question" aria-hidden="true"></i>
            </span>
        </label>
        <select asp-for="ConnectionName" asp-items="Model.ConnectionNames" class="form-select">
            <option value="">@T["Default connection"]</option>
        </select>
        <span asp-validation-for="ConnectionName" class="text-danger"></span>
    </div>
}
else
{
    <input type="hidden" asp-for="ConnectionName" />
}

<div class="mb-3" data-orchestrator-field="deployment">
    <label asp-for="DeploymentId" class="form-label">
        @T["Deployment"]
        <span class="text-muted" data-bs-toggle="tooltip" title="@T["The AI model deployment to use for this chat interaction. If not selected, the default deployment will be used."]">
            <i class="fa-solid fa-circle-question" aria-hidden="true"></i>
        </span>
    </label>
    <select asp-for="DeploymentId" class="form-select">
        <option value="">@T["Default deployment"]</option>
        @if (Model.Deployments != null)
        {
            foreach (var deployment in Model.Deployments)
            {
                <option value="@deployment.Value">@deployment.Text</option>
            }
        }
    </select>
    <span asp-validation-for="DeploymentId" class="text-danger"></span>
</div>

<script at="Foot">
    document.addEventListener('DOMContentLoaded', function () {

        const connectionNameElement = document.getElementById('@Html.IdFor(x => x.ConnectionName)');
        const deploymentsElement = document.getElementById('@Html.IdFor(x => x.DeploymentId)');
        const providerName = '@(Model.ProviderName)';
        const orchestratorSelector = document.getElementById('ci-orchestrator-selector');

        if (connectionNameElement) {
            connectionNameElement.addEventListener('change', async (e) => {
                const selectedConnection = e.target.value;

                // Remove only options that have a value
                [...deploymentsElement.options].forEach(option => {
                    if (option.value) {
                        option.remove();
                    }
                });

                if (!selectedConnection) {
                    deploymentsElement.value = '';
                    return;
                }

                var url = '@(Url.RouteUrl(AIConstants.RouteNames.GetDeploymentsByConnectionRouteName))';
                try {
                    const response = await fetch(`${url}?providerName=${encodeURIComponent(providerName)}&connection=${encodeURIComponent(selectedConnection)}`);

                    if (!response.ok) {
                        throw new Error('Failed to fetch deployments');
                    }

                    const deployments = await response.json();

                    // Populate new options
                    deployments.forEach(deployment => {
                        let option = document.createElement('option');
                        option.value = deployment.id;
                        option.textContent = deployment.name;
                        deploymentsElement.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error fetching deployments:', error);
                }
            });
        }

        if (orchestratorSelector) {
            function updateFieldVisibility() {
                const selectedOrchestrator = orchestratorSelector.value || 'default';
                const isDefault = selectedOrchestrator.toLowerCase() === 'default' || selectedOrchestrator === '';

                // Hide/show connection and deployment fields for non-default orchestrators
                document.querySelectorAll('[data-orchestrator-field="connection"], [data-orchestrator-field="deployment"]').forEach(el => {
                    el.style.display = isDefault ? '' : 'none';
                });

                // Show/hide Copilot-specific fields
                const isCopilot = selectedOrchestrator.toLowerCase() === 'copilot';
                document.querySelectorAll('[data-orchestrator-field="copilot"]').forEach(el => {
                    el.style.display = isCopilot ? '' : 'none';
                });
            }

            updateFieldVisibility();
            orchestratorSelector.addEventListener('change', updateFieldVisibility);
        }
    });
</script>
