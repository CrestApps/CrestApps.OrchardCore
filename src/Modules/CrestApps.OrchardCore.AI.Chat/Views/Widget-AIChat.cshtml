@using CrestApps.OrchardCore.AI
@using CrestApps.OrchardCore.AI.Core
@using CrestApps.OrchardCore.AI.Core.Models
@using CrestApps.OrchardCore.AI.Models
@using CrestApps.OrchardCore.SignalR.Core.Services
@using Microsoft.AspNetCore.Authorization
@using OrchardCore.ContentManagement
@using OrchardCore.Entities
@using OrchardCore.Environment.Shell
@using OrchardCore.Environment.Shell.Scope
@using Microsoft.Extensions.DependencyInjection
@using CrestApps.OrchardCore.AI.Chat.Hubs
@using CrestApps.OrchardCore.Services
@using Microsoft.Extensions.Options

@inject INamedCatalog<AIProfile> ProfileCatalog
@inject IAuthorizationService AuthorizationService
@inject ShellSettings ShellSettings
@inject HubRouteManager HubRouteManager
@{
    ContentItem contentItem = Model.ContentItem;

    var part = contentItem.As<AIProfilePart>();

    if (string.IsNullOrEmpty(part?.ProfileId))
    {
        return;
    }

    var profile = await ProfileCatalog.FindByIdAsync(part.ProfileId);

    if (profile == null)
    {
        return;
    }

    if (!await AuthorizationService.AuthorizeAsync(User, AIPermissions.QueryAnyAIProfile, profile))
    {
        return;
    }

    var hubLink = HubRouteManager.GetUriByHub<AIChatHub>(ViewContext.HttpContext);
    var showHistory = part.TotalHistory.HasValue && part.TotalHistory.Value > 0;
    var promptGeneratedProfiles = await ProfileCatalog.GetAsync(AIProfileType.TemplatePrompt);

    var baseId = $"Widget_{contentItem.ContentItemId}";
    var chatAppHtmlId = $"{baseId}_ChatApp";
    var buttonHtmlId = $"{baseId}_SendButton";
    var userPromptHtmlId = $"{baseId}_UserPrompt";
    var chatContainerHtmlId = $"{baseId}_ChatContainer";
    var placeholderHtmlId = $"{baseId}_SessionPlaceHolder";
    var widgetContainerId = $"{baseId}_Container";
    var toggleBtnId = $"{baseId}_Toggle";
    var closeBtnId = $"{baseId}_Close";
    var newChatBtnId = $"{baseId}_NewChat";
    var historyBtnId = $"{baseId}_ShowHistory";
    var historyPanelId = $"{baseId}_HistoryPanel";
    var closeHistoryBtnId = $"{baseId}_CloseHistory";
    var restoreSizeBtnId = $"{baseId}_RestoreSize";
    var documentBarHtmlId = $"{baseId}_DocumentBar";

    var storagePrefix = $"{ShellSettings.Name}-{baseId}";

    var shellFeaturesManager = ShellScope.Services.GetRequiredService<IShellFeaturesManager>();
    var enabledFeatures = await shellFeaturesManager.GetEnabledFeaturesAsync();
    var sessionDocumentsFeatureEnabled = enabledFeatures.Any(f => f.Id == AIConstants.Feature.ChatSessionDocuments);
    var sessionDocumentsEnabled = sessionDocumentsFeatureEnabled
        && profile.As<AIProfileSessionDocumentsMetadata>().AllowSessionDocuments;
    var allowedExtensions = string.Empty;
    if (sessionDocumentsEnabled)
    {
        var chatDocOptions = ShellScope.Services.GetRequiredService<IOptions<ChatDocumentsOptions>>();
        allowedExtensions = string.Join(", ", chatDocOptions.Value.AllowedFileExtensions);
    }
}

<!-- Toggle Button -->
<button id="@toggleBtnId" class="ai-admin-widget-toggle-btn" title="@T["Open AI Chat"]" style="--ai-widget-primary: var(--bs-primary, #0d6efd);">
    <i class="fas fa-comments"></i>
</button>

<!-- Widget Container -->
<div id="@widgetContainerId" class="ai-admin-widget" style="--ai-widget-primary: var(--bs-primary, #0d6efd);">
    <!-- Header (drag handle) -->
    <div class="ai-admin-widget-header">
        <span class="ai-admin-widget-title">
            @if (Model.Header != null)
            {
                @await DisplayAsync(Model.Header)
            }
            else
            {
                @T["AI Chat"]
            }
        </span>
        <div class="ai-admin-widget-header-actions">
            <button class="btn btn-link ai-admin-widget-restore-btn" id="@restoreSizeBtnId" title="@T["Restore size"]">
                <i class="fas fa-compress"></i>
            </button>
            <button class="btn btn-link" id="@newChatBtnId" title="@T["New chat"]">
                <i class="fas fa-plus"></i>
            </button>
            @if (showHistory)
            {
                <button class="btn btn-link" id="@historyBtnId" title="@T["Chat history"]">
                    <i class="fas fa-clock-rotate-left"></i>
                </button>
            }
            <button class="btn btn-link" id="@closeBtnId" title="@T["Close"]">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Resize Handle (top-left, below header) -->
    <div class="ai-admin-widget-resize-handle"></div>

    <!-- Chat Body -->
    <div class="ai-admin-widget-body" id="@chatContainerHtmlId">
        <div id="@placeholderHtmlId" class="ai-admin-widget-placeholder">
            <h4>@(string.IsNullOrEmpty(profile.WelcomeMessage) ? T["What do you want to know?"] : profile.WelcomeMessage)</h4>
        </div>
        <div id="@chatAppHtmlId"></div>
    </div>

    <!-- Input Area -->
    <div class="ai-admin-widget-input">
        @if (sessionDocumentsEnabled)
        {
            <div id="@documentBarHtmlId" class="d-none"></div>
        }
        <div class="ai-admin-widget-input-wrapper">
            @if (promptGeneratedProfiles.Any())
            {
                <div class="dropdown me-1">
                    <button class="btn btn-sm btn-link text-secondary p-1" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="@T["Prompt templates"]">
                        <i class="fa-solid fa-screwdriver-wrench"></i>
                    </button>
                    <ul class="dropdown-menu">
                        @foreach (var promptGeneratedProfile in promptGeneratedProfiles)
                        {
                            <li>
                                <button type="button" class="dropdown-item profile-generated-prompt" data-profile-id="@promptGeneratedProfile.ItemId">@promptGeneratedProfile.Name</button>
                            </li>
                        }
                    </ul>
                </div>
            }
            <textarea class="ai-admin-widget-prompt"
                      id="@userPromptHtmlId"
                      data-session-id=""
                      data-profile-id="@(profile.ItemId)"
                      placeholder="@T["Message..."]"
                      rows="1"
                      aria-label="@T["Message"]"></textarea>
            <button class="ai-admin-widget-send-btn"
                    id="@buttonHtmlId"
                    disabled
                    data-start-icon="<i class='fa-solid fa-arrow-up'></i>"
                    data-stop-icon="<i class='fa-solid fa-stop'></i>">
                <i class="fa-solid fa-arrow-up"></i>
            </button>
        </div>
    </div>

    @if (showHistory)
    {
        <!-- History Panel -->
        <div class="ai-admin-widget-history-panel" id="@historyPanelId">
            <div class="history-header">
                <h5>@T["Chat History"]</h5>
                <button class="btn btn-sm btn-link text-secondary" id="@closeHistoryBtnId">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            @await DisplayAsync(Model.History)
        </div>
    }
</div>

<style asp-name="AIChatWidget" at="Head"></style>
<style asp-name="highlightjs" at="Head"></style>
<script asp-name="AIChatWidget" at="Foot"></script>
<script asp-name="OpenAIChatApp" at="Foot"></script>
<script at="Foot" depends-on="AIChatWidget, OpenAIChatApp">
    aiChatAdminWidget.initialize({
        containerSelector: '#@widgetContainerId',
        toggleSelector: '#@toggleBtnId',
        closeButtonSelector: '#@closeBtnId',
        newChatButtonSelector: '#@newChatBtnId',
        showHistorySelector: '#@historyBtnId',
        historyPanelSelector: '#@historyPanelId',
        closeHistorySelector: '#@closeHistoryBtnId',
        restoreSizeSelector: '#@restoreSizeBtnId',
        promptSelector: '#@userPromptHtmlId',
        storagePrefix: '@storagePrefix',
        chatConfig: {
            signalRHubUrl: '@hubLink',
            appElementSelector: '#@chatAppHtmlId',
            chatContainerElementSelector: '#@chatContainerHtmlId',
            inputElementSelector: '#@userPromptHtmlId',
            sendButtonElementSelector: '#@buttonHtmlId',
            placeholderElementSelector: '#@placeholderHtmlId',
            messages: [],
            @if (sessionDocumentsEnabled)
            {
                @:sessionDocumentsEnabled: true,
                @:documentBarSelector: '#@documentBarHtmlId',
                @:uploadDocumentUrl: '@Url.RouteUrl(AIConstants.RouteNames.ChatSessionUploadDocument)',
                @:removeDocumentUrl: '@Url.RouteUrl(AIConstants.RouteNames.ChatSessionRemoveDocument)',
                @:allowedExtensions: '@allowedExtensions',
                @:existingDocuments: [],
            }
            messageTemplate: `
                <div>
                    <div v-for="(message, index) in messages" :key="index" class="ai-chat-message-item">
                        <div>
                            <div v-if="message.role === 'user'" class="ai-admin-widget-msg-role ai-admin-widget-msg-role-user">@T["You"]</div>
                            <div v-else-if="message.role !== 'indicator'" class="ai-admin-widget-msg-role ai-admin-widget-msg-role-assistant">
                                <i :class="'fa fa-robot' + (message.isStreaming ? ' ai-streaming-icon' : ' ai-bot-icon')"></i>
                                @T["Assistant"]
                            </div>
                            <div class="min-w-0">
                                <h6 v-if="message.title" class="mb-1" style="font-size: 0.8rem;">{{ message.title }}</h6>
                                <div v-html="message.htmlContent || message.content" style="font-size: 0.85rem; line-height: 1.5;"></div>
                                <span class="message-buttons-container" v-if="!isIndicator(message)">
                                    <button class="btn btn-sm btn-link text-secondary p-0" @@click="copyResponse(message.content)" title="@T["Copy"]">
                                        <i class="fa-solid fa-copy" style="font-size: 0.75rem;"></i>
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            indicatorTemplate: `
                <div class="ai-admin-widget-msg-role ai-admin-widget-msg-role-assistant">
                    <i class="fa fa-robot ai-streaming-icon" style="display: inline-block;"></i>
                    @T["Assistant"]
                </div>
            `
        }
    });
</script>
