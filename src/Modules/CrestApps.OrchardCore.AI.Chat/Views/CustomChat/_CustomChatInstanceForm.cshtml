@using CrestApps.OrchardCore.AI.Chat.ViewModels
@using OrchardCore

@model CustomChatInstanceViewModel

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="Title" class="@Orchard.GetLabelClasses()">@T["Title"]</label>
    <div class="@Orchard.GetEndClasses()">
        <input type="text" class="form-control" asp-for="Title" />
        <span asp-validation-for="Title" class="text-danger"></span>
        <span class="hint">@T["A descriptive title for this chat instance."]</span>
    </div>
</div>

@if (Model.ConnectionNames?.Any() == true)
{
    <div class="@Orchard.GetWrapperClasses()">
        <label asp-for="ConnectionName" class="@Orchard.GetLabelClasses()">@T["Connection"]</label>
        <div class="@Orchard.GetEndClasses()">
            <select asp-for="ConnectionName" asp-items="Model.ConnectionNames" class="form-select">
                <option value="">@T["Default connection"]</option>
            </select>
            <span asp-validation-for="ConnectionName" class="text-danger"></span>
            <span class="hint">@T["The AI provider connection to use."]</span>
        </div>
    </div>
}

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="DeploymentId" class="@Orchard.GetLabelClasses()">@T["Deployment"]</label>
    <div class="@Orchard.GetEndClasses()">
        <select asp-for="DeploymentId" class="form-select">
            <option value="">@T["Default deployment"]</option>
            @if (Model.Deployments != null)
            {
                foreach (var deployment in Model.Deployments)
                {
                    <option value="@deployment.Value">@deployment.Text</option>
                }
            }
        </select>
        <span asp-validation-for="DeploymentId" class="text-danger"></span>
        <span class="hint">@T["The AI model deployment to use."]</span>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="SystemMessage" class="@Orchard.GetLabelClasses()">@T["System instructions"]</label>
    <div class="@Orchard.GetEndClasses()">
        <div class="hint mb-1">@T["The system instruction sets the AI's behavior and response style, guiding how it interacts in a conversation."]</div>
        <textarea asp-for="SystemMessage" class="form-control" rows="5"></textarea>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="MaxTokens" class="@Orchard.GetLabelClasses()">@T["Max response"]</label>
    <div class="@Orchard.GetEndClasses()">
        <input type="number" class="form-control" asp-for="MaxTokens" step="4" min="4">
        <span class="hint">@T["Set a limit on the number of tokens per model response. One token is roughly 4 characters for typical English text."]</span>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="Temperature" class="@Orchard.GetLabelClasses()">@T["Temperature"]</label>
    <div class="@Orchard.GetEndClasses()">
        <input type="number" class="form-control" asp-for="Temperature" step="0.01" min="0" max="1">
        <span class="hint">@T["Controls randomness. Lower values produce more deterministic responses."]</span>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="TopP" class="@Orchard.GetLabelClasses()">@T["Top P"]</label>
    <div class="@Orchard.GetEndClasses()">
        <input type="number" class="form-control" asp-for="TopP" step="0.01" min="0" max="1">
        <span class="hint">@T["Controls randomness using nucleus sampling. Try adjusting temperature or Top P but not both."]</span>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="FrequencyPenalty" class="@Orchard.GetLabelClasses()">@T["Frequency penalty"]</label>
    <div class="@Orchard.GetEndClasses()">
        <input type="number" class="form-control" asp-for="FrequencyPenalty" step="0.01" min="0" max="1">
        <span class="hint">@T["Reduce the chance of repeating a token based on how often it has appeared."]</span>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="PresencePenalty" class="@Orchard.GetLabelClasses()">@T["Presence penalty"]</label>
    <div class="@Orchard.GetEndClasses()">
        <input type="number" class="form-control" asp-for="PresencePenalty" step="0.01" min="0" max="1">
        <span class="hint">@T["Reduce the chance of repeating any token that has appeared at all."]</span>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="PastMessagesCount" class="@Orchard.GetLabelClasses()">@T["Past messages included"]</label>
    <div class="@Orchard.GetEndClasses()">
        <input type="number" class="form-control" asp-for="PastMessagesCount" step="1" min="2" max="20">
        <span class="hint">@T["Number of past messages to include for context."]</span>
    </div>
</div>

@if (Model.Tools is not null && Model.Tools.Count > 0)
{
    <h4 class="border-bottom pb-2 mt-4">@T["Tools"]</h4>

    <div class="mb-3">
        @foreach (var tools in Model.Tools)
        {
            var groupKey = tools.Key;
            var groupId = groupKey.Replace(" ", "-");

            <div class="mb-3">
                <h5>@groupKey</h5>

                <div class="form-check">
                    <input class="form-check-input group-toggle"
                           type="checkbox"
                           id="selectAll_@groupId"
                           data-group="@groupId" />
                    <label class="form-check-label" for="selectAll_@groupId">
                        @T["Select All items in {0}", groupKey]
                    </label>
                </div>

                <div class="ms-3">
                    @for (var i = 0; i < tools.Value.Length; i++)
                    {
                        <div class="form-check">
                            <input type="hidden" asp-for="@Model.Tools[groupKey][i].ItemId" />
                            <input asp-for="@Model.Tools[groupKey][i].IsSelected"
                                   type="checkbox"
                                   class="form-check-input group-checkbox"
                                   data-group="@groupId"
                                   id="tool_@(groupId)_@i" />

                            <label class="form-check-label"
                                   asp-for="@Model.Tools[groupKey][i].IsSelected">
                                @tools.Value[i].DisplayText
                            </label>
                            <span class="hint dashed">@tools.Value[i].Description</span>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <script at="Foot">
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.group-toggle').forEach(toggle => {
                toggle.addEventListener('change', function () {
                    const groupName = this.dataset.group;
                    const checkboxes = document.querySelectorAll(`.group-checkbox[data-group="${groupName}"]`);
                    checkboxes.forEach(cb => cb.checked = this.checked);
                });
            });

            document.querySelectorAll('.group-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const groupName = this.dataset.group;
                    const all = document.querySelectorAll(`.group-checkbox[data-group="${groupName}"]`);
                    const allChecked = [...all].every(cb => cb.checked);
                    const toggle = document.querySelector(`.group-toggle[data-group="${groupName}"]`);
                    toggle.checked = allChecked;
                });
            });
        });
    </script>
}

@if (!string.IsNullOrEmpty(Model.ProviderName))
{
    <input type="hidden" asp-for="ProviderName" />

    <script at="Foot">
        document.addEventListener('DOMContentLoaded', function () {
            const connectionNameElement = document.getElementById('@Html.IdFor(x => x.ConnectionName)');
            const deploymentsElement = document.getElementById('@Html.IdFor(x => x.DeploymentId)');
            const providerName = '@(Model.ProviderName)';

            if (connectionNameElement) {
                connectionNameElement.addEventListener('change', async (e) => {
                    const selectedConnection = e.target.value;

                    [...deploymentsElement.options].forEach(option => {
                        if (option.value) {
                            option.remove();
                        }
                    });

                    if (!selectedConnection) {
                        deploymentsElement.value = '';
                        return;
                    }

                    var url = '@(Url.RouteUrl(CrestApps.OrchardCore.AI.Core.AIConstants.RouteNames.GetDeploymentsByConnectionRouteName))';
                    try {
                        const response = await fetch(`${url}?providerName=${encodeURIComponent(providerName)}&connection=${encodeURIComponent(selectedConnection)}`);

                        if (!response.ok) {
                            throw new Error('Failed to fetch deployments');
                        }

                        const deployments = await response.json();

                        deployments.forEach(deployment => {
                            let option = document.createElement('option');
                            option.value = deployment.id;
                            option.textContent = deployment.name;
                            deploymentsElement.appendChild(option);
                        });
                    } catch (error) {
                        console.error('Error fetching deployments:', error);
                    }
                });
            }
        });
    </script>
}
