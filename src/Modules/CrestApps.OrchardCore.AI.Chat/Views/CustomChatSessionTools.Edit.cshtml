@model CrestApps.OrchardCore.AI.Chat.ViewModels.CustomChatViewModel

@using OrchardCore.Mvc.Utilities

<div class="tab-pane" id="tools" role="tabpanel">

    @if (Model.Tools == null || Model.Tools.Count == 0)
    {
        <p class="text-muted">@T["No tools are available."]</p>
    }
    else
    {
        foreach (var item in Model.Tools)
        {
            <div class="mb-3">
                <h6 class="text-uppercase text-muted mb-2">@item.Key</h6>

                <div class="row g-3">
                    @for (var i = 0; i < item.Value.Length; i++)
                    {
                        var tool = item.Value[i];

                        <div class="col-12 col-md-6 col-lg-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-start">
                                        <div class="form-check me-2">
                                            <input type="hidden"
                                                   name="@($"{Html.NameFor(m => m.Tools)}[{item.Key}][{i}].ItemId")"
                                                   value="@tool.ItemId" />

                                            <input type="hidden"
                                                   name="@($"{Html.NameFor(m => m.Tools)}[{item.Key}][{i}].DisplayText")"
                                                   value="@tool.DisplayText" />

                                            <input type="checkbox"
                                                   class="form-check-input custom-chat-tool-checkbox"
                                                   id="@tool.ItemId"
                                                   data-tool-category="@item.Key"
                                                   name="@($"{Html.NameFor(m => m.Tools)}[{item.Key}][{i}].IsSelected")"
                                                   value="true" @(tool.IsSelected ? "checked" : null) />
                                        </div>

                                        <div class="flex-grow-1">
                                            <label class="form-check-label d-block" for="@tool.ItemId">
                                                <span class="fw-bold">@tool.DisplayText</span>
                                                @if (!string.IsNullOrWhiteSpace(tool.Description))
                                                {
                                                    <span class="text-muted small mt-1">
                                                        @tool.Description
                                                    </span>
                                                }
                                            </label>
                                        </div>
                                    </div>

                                    @if (string.Equals(item.Key, "DocumentReader", System.StringComparison.OrdinalIgnoreCase))
                                    {
                                        <div id="documentReaderUploadContainer" class="form-group d-none mt-3">
                                            <label class="form-label">@T["Upload document"]</label>
                                            <input type="file" class="form-control" id="customChatDocumentUpload" />
                                            <small class="text-muted d-block">
                                                @T["Upload a document so the AI can reference it during this chat session."]
                                            </small>

                                            @* File name display after successful upload *@
                                            <div class="mt-2">
                                                <span class="badge text-bg-secondary d-none" id="uploadedFileNameBadge"></span>
                                            </div>

                                            @* List of all uploaded documents *@
                                            <div class="mt-2">
                                                <ul class="list-group" id="uploadedFilesList"></ul>
                                            </div>
                                        </div>
                                    }
                                </div>

                                <div class="card-footer bg-transparent d-flex justify-content-between align-items-center">
                                    <span class="badge text-bg-light">@item.Key</span>
                                    <span class="text-muted small">@T["Tool"]</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }

</div>

<script>
    (function () {
        const uploadContainer = document.getElementById("documentReaderUploadContainer");

        const toolCheckboxes = document.querySelectorAll(".custom-chat-tool-checkbox");

        if (uploadContainer) {
            const toggleUploadVisibility = () => {
                let enabled = false;

                toolCheckboxes.forEach(function (checkbox) {
                    if (checkbox.dataset.toolCategory === "DocumentReader" && checkbox.checked) {
                        enabled = true;
                    }
                });

                if (enabled) {
                    uploadContainer.classList.remove("d-none");
                } else {
                    uploadContainer.classList.add("d-none");
                }
            };

            toolCheckboxes.forEach(function (checkbox) {
                checkbox.addEventListener("change", toggleUploadVisibility);
            });

            toggleUploadVisibility();
        } else {
            console.warn("[CustomChat][Init] Upload container not found.");
        }

        const input = document.getElementById("customChatDocumentUpload");

        if (!input) {
            return;
        }

        const uploadUrl = '@Url.Action("Upload", "CustomChatDocument", new { area = "CrestApps.OrchardCore.AI.Chat" })';

        const filesList = document.getElementById("uploadedFilesList");

        input.addEventListener("change", async function () {
            if (!this.files || this.files.length === 0) {
                return;
            }

            const file = this.files[0];

            const formData = new FormData();

            formData.append("file", file);

            formData.append("customChatInstanceId", "@Model.CustomChatInstanceId");

            try {
                const response = await fetch(uploadUrl, { method: "POST", body: formData });

                if (!response.ok) {
                    console.error("[CustomChat][Upload] Upload failed. Status:", response.status);
                    return;
                }

                const badge = document.getElementById("uploadedFileNameBadge");

                if (badge) {
                    badge.textContent = file.name;
                    badge.classList.remove("d-none");
                } else {
                    console.warn("[CustomChat][UI] Badge element not found.");
                }

                if (filesList) {
                    const li = document.createElement("li");
                    li.className = "list-group-item d-flex justify-content-between align-items-center";
                    li.textContent = file.name;

                    const small = document.createElement("small");
                    small.className = "text-muted";
                    small.textContent = new Date().toLocaleString();

                    li.appendChild(small);
                    filesList.appendChild(li);
                    console.log("[CustomChat][UI] Appended to uploaded files list:", file.name);
                } else {
                    console.warn("[CustomChat][UI] Uploaded files list element not found.");
                }
            } catch (error) {
                console.debug("[CustomChat][Upload] Upload error:", error);
            } finally {
                this.value = "";
                console.log("[CustomChat][Upload] Input reset after upload.");
            }
        });
    })();
</script>