function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,o,a,s=[],c=!0,l=!1;try{if(o=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=o.call(n)).done)&&(s.push(r.value),s.length!==t);c=!0);}catch(e){l=!0,i=e}finally{try{if(!c&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(l)throw i}}return s}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _regenerator(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function o(n,r,i,o){var c=r&&r.prototype instanceof s?r:s,l=Object.create(c.prototype);return _regeneratorDefine2(l,"_invoke",function(n,r,i){var o,s,c,l=0,d=i||[],u=!1,h={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,n){return o=t,s=0,c=e,h.n=n,a}};function f(n,r){for(s=n,c=r,t=0;!u&&l&&!i&&t<d.length;t++){var i,o=d[t],f=h.p,g=o[2];n>3?(i=g===r)&&(c=o[(s=o[4])?5:(s=3,3)],o[4]=o[5]=e):o[0]<=f&&((i=n<2&&f<o[1])?(s=0,h.v=r,h.n=o[1]):f<g&&(i=n<3||o[0]>r||r>g)&&(o[4]=n,o[5]=r,h.n=g,s=0))}if(i||n>1)return a;throw u=!0,r}return function(i,d,g){if(l>1)throw TypeError("Generator is already running");for(u&&1===d&&f(d,g),s=d,c=g;(t=s<2?e:c)||!u;){o||(s?s<3?(s>1&&(h.n=-1),f(s,c)):h.n=c:h.v=c);try{if(l=2,o){if(s||(i="next"),t=o[i]){if(!(t=t.call(o,c)))throw TypeError("iterator result is not an object");if(!t.done)return t;c=t.value,s<2&&(s=0)}else 1===s&&(t=o.return)&&t.call(o),s<2&&(c=TypeError("The iterator does not provide a '"+i+"' method"),s=1);o=e}else if((t=(u=h.n<0)?c:n.call(r,h))!==a)break}catch(t){o=e,s=1,c=t}finally{l=1}}return{value:t,done:u}}}(n,i,o),!0),l}var a={};function s(){}function c(){}function l(){}t=Object.getPrototypeOf;var d=[][r]?t(t([][r]())):(_regeneratorDefine2(t={},r,function(){return this}),t),u=l.prototype=s.prototype=Object.create(d);function h(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,l):(e.__proto__=l,_regeneratorDefine2(e,i,"GeneratorFunction")),e.prototype=Object.create(u),e}return c.prototype=l,_regeneratorDefine2(u,"constructor",l),_regeneratorDefine2(l,"constructor",c),c.displayName="GeneratorFunction",_regeneratorDefine2(l,i,"GeneratorFunction"),_regeneratorDefine2(u),_regeneratorDefine2(u,i,"Generator"),_regeneratorDefine2(u,r,function(){return this}),_regeneratorDefine2(u,"toString",function(){return"[object Generator]"}),(_regenerator=function(){return{w:o,m:h}})()}function _regeneratorDefine2(e,t,n,r){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}_regeneratorDefine2=function(e,t,n,r){function o(t,n){_regeneratorDefine2(e,t,function(e){return this._invoke(t,n,e)})}t?i?i(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(o("next",0),o("throw",1),o("return",2))},_regeneratorDefine2(e,t,n,r)}function asyncGeneratorStep(e,t,n,r,i,o,a){try{var s=e[o](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,i)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var o=e.apply(t,n);function a(e){asyncGeneratorStep(o,r,i,a,s,"next",e)}function s(e){asyncGeneratorStep(o,r,i,a,s,"throw",e)}a(void 0)})}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}window.openAIChatManager=function(){var e={generatedImageAltText:"Generated Image",generatedImageMaxWidth:400,generatedChartMaxWidth:900,downloadImageTitle:"Download image",downloadChartTitle:"Download chart as image",downloadChartButtonText:"Download",messageTemplate:'\n        <div class="ai-chat-messages">\n            <div v-for="(message, index) in messages" :key="index" class="ai-chat-message-item">\n                <div>\n                    <div v-if="message.role === \'user\'" class="ai-chat-msg-role ai-chat-msg-role-user">You</div>\n                    <div v-else-if="message.role !== \'indicator\'" class="ai-chat-msg-role ai-chat-msg-role-assistant">\n                        <i :class="\'fa fa-robot\' + (message.isStreaming ? \' ai-streaming-icon\' : \' ai-bot-icon\')"></i>\n                        Assistant\n                    </div>\n                    <div class="lh-base">\n                        <h4 v-if="message.title">{{ message.title }}</h4>\n                        <div v-html="message.htmlContent || message.content"></div>\n                        <span class="message-buttons-container" v-if="!isIndicator(message)">\n                            <button class="btn btn-sm btn-link text-secondary p-0 button-message-toolbox" @click="copyResponse(message.content)" title="Click here to copy response to clipboard.">\n                                <i class="fa-solid fa-copy"></i>\n                            </button>\n                        </span>\n                    </div>\n                </div>\n            </div>\n        </div>\n    ',indicatorTemplate:'\n        <div class="ai-chat-msg-role ai-chat-msg-role-assistant">\n            <i class="fa fa-robot ai-streaming-icon" style="display: inline-block;"></i>\n            Assistant\n        </div>\n    '},t=new marked.Renderer;t.link=function(e){return'<a href="'.concat(e.href,'" target="_blank" rel="noopener noreferrer">').concat(e.text,"</a>")},t.code=function(e){var t=e.text||"",n=(e.lang||"").trim(),r=t;if("undefined"!=typeof hljs)if(n&&hljs.getLanguage(n))try{r=hljs.highlight(t,{language:n}).value}catch(e){}else try{r=hljs.highlightAuto(t).value}catch(e){}else r=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");var i=n?' data-lang="'.concat(n,'"'):"";return"<pre".concat(i,'><button type="button" class="ai-code-copy-btn" title="Copy code"><i class="fa-solid fa-copy"></i></button><code class="hljs').concat(n?" language-"+n:"",'">').concat(r,"</code></pre>")},t.image=function(t){var n=t.href,r=t.text||e.generatedImageAltText,i=e.generatedImageMaxWidth;return'<div class="generated-image-container">\n        <img src="'.concat(n,'" alt="').concat(r,'" class="img-thumbnail" style="max-width: ').concat(i,'px; height: auto;" />\n        <div class="mt-2">\n            <a href="').concat(n,'" target="_blank" download="').concat(r,'" title="').concat(e.downloadImageTitle,'" class="btn btn-sm btn-outline-secondary ai-download-image">\n                <i class="fa-solid fa-download"></i>\n            </a>\n        </div>\n    </div>')};var n=0,r=[];function i(e){if(e&&e._pendingCharts&&e._pendingCharts.length){var t,n=_createForOfIteratorHelper(e._pendingCharts);try{for(n.s();!(t=n.n()).done;){var r=t.value,i=document.getElementById(r.chartId);if(i)if("undefined"!=typeof Chart)try{var o;i._chartInstance&&i._chartInstance.destroy();var a="string"==typeof r.config?JSON.parse(r.config):r.config;null!==(o=a.options)&&void 0!==o||(a.options={}),a.options.responsive=!0,a.options.maintainAspectRatio=!1,i._chartInstance=new Chart(i,a)}catch(e){console.error("Error creating chart:",e)}else console.error("Chart.js is not available on the page.")}}catch(e){n.e(e)}finally{n.f()}e._pendingCharts=[]}}function o(e,n){r=[];var i=marked.parse(e,{renderer:t});return n._pendingCharts=r.length>0?_toConsumableArray(r):[],i}marked.use({extensions:[{name:"chart",level:"block",start:function(e){var t=e.indexOf("[chart:");return t>=0?t:void 0},tokenizer:function(e){var t=function(e){var t="[chart:",n=e.indexOf(t);if(n<0)return null;var r=n+t.length,i=r;for(;i<e.length&&(" "===e[i]||"\n"===e[i]||"\r"===e[i]||"\t"===e[i]);)i++;if(i>=e.length||"{"!==e[i])return null;for(var o=0,a=!1,s=!1;i<e.length;i++){var c=e[i];if(a){if(s){s=!1;continue}if("\\"===c){s=!0;continue}'"'===c&&(a=!1)}else if('"'!==c){if("{"===c)o++;else if("}"===c&&0===--o){var l=i,d=e.indexOf("]",l+1);return d<0?null:{startIndex:n,endIndex:d+1,json:e.substring(r,l+1).trim()}}}else a=!0}return null}(e);if(t&&0===t.startIndex){var r="chat_chart_".concat(++n);return{type:"chart",raw:e.substring(0,t.endIndex),chartId:r,json:t.json}}},renderer:function(t){return r.push({chartId:t.chartId,config:t.json}),n=t.chartId,i=e.generatedChartMaxWidth,'<div class="chart-container" style="position: relative; width: 100%; max-width: '.concat(i,'px; margin: 0 auto; height: 480px;">')+'<canvas id="'.concat(n,'" class="img-thumbnail" width="').concat(i,'" height="480" style="width: 100%; height: 480px;"></canvas>')+'</div><div class="mt-2">'+'<button type="button" class="btn btn-sm btn-outline-secondary" onclick="downloadChart(\''.concat(n,'\')" title="').concat(e.downloadChartTitle,'">')+'<i class="fa-solid fa-download"></i> '.concat(e.downloadChartButtonText)+"</button></div>";var n,i}}]});return{initialize:function(t){var n=Object.assign({},e,t);if(e=n,n.signalRHubUrl)if(n.appElementSelector)if(n.chatContainerElementSelector)if(n.inputElementSelector){if(n.sendButtonElementSelector)return Vue.createApp({data:function(){return{inputElement:null,buttonElement:null,chatContainer:null,placeholder:null,isSessionStarted:!1,isPlaceholderVisible:!0,chatWidgetStateName:null,chatWidgetStateSession:null,chatHistorySection:null,widgetIsInitialized:!1,isSteaming:!1,isNavigatingAway:!1,autoScroll:!0,stream:null,messages:[],prompt:"",documents:n.existingDocuments||[],isUploading:!1,isDragOver:!1,documentBar:null}},methods:{handleBeforeUnload:function(){this.isNavigatingAway=!0},handleDragOver:function(e){if(n.sessionDocumentsEnabled){e.preventDefault(),e.stopPropagation(),this.isDragOver=!0;var t=this.inputElement?this.inputElement.closest(".ai-admin-widget-input, .text-bg-light"):null;t&&t.classList.add("ai-chat-drag-over")}},handleDragLeave:function(e){if(n.sessionDocumentsEnabled){e.preventDefault(),e.stopPropagation(),this.isDragOver=!1;var t=this.inputElement?this.inputElement.closest(".ai-admin-widget-input, .text-bg-light"):null;t&&t.classList.remove("ai-chat-drag-over")}},handleDrop:function(e){if(n.sessionDocumentsEnabled){e.preventDefault(),e.stopPropagation(),this.isDragOver=!1;var t=this.inputElement?this.inputElement.closest(".ai-admin-widget-input, .text-bg-light"):null;t&&t.classList.remove("ai-chat-drag-over"),e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length>0&&this.uploadFiles(e.dataTransfer.files)}},triggerFileInput:function(){if(n.sessionDocumentsEnabled){var e=document.getElementById("ai-chat-doc-input");e&&e.click()}},handleFileInputChange:function(e){var t=e.target.files;t&&t.length>0&&this.uploadFiles(t),e.target.value=""},uploadFiles:function(e){var t=this;return _asyncToGenerator(_regenerator().m(function r(){var i,o,a,s,c,l,d,u,h,f;return _regenerator().w(function(r){for(;;)switch(r.p=r.n){case 0:if(n.uploadDocumentUrl){r.n=1;break}return r.a(2);case 1:if(i=t.getSessionId(),o=t.getProfileId(),i||o){r.n=2;break}return console.warn("Cannot upload documents without a session or profile."),r.a(2);case 2:for(t.isUploading=!0,r.p=3,a=new FormData,i?a.append("sessionId",i):a.append("profileId",o),s=0;s<e.length;s++)a.append("files",e[s]);return r.n=4,fetch(n.uploadDocumentUrl,{method:"POST",body:a});case 4:if((c=r.v).ok){r.n=6;break}return r.n=5,c.text();case 5:return l=r.v,console.error("Upload failed:",l),r.a(2);case 6:return r.n=7,c.json();case 7:if((d=r.v).sessionId&&!i&&t.initializeSession(d.sessionId),d.uploaded&&d.uploaded.length>0)for(u=0;u<d.uploaded.length;u++)t.documents.push(d.uploaded[u]);if(d.failed&&d.failed.length>0)for(h=0;h<d.failed.length;h++)console.warn("File failed to upload:",d.failed[h].fileName,d.failed[h].error);r.n=9;break;case 8:r.p=8,f=r.v,console.error("Upload error:",f);case 9:return r.p=9,t.isUploading=!1,r.f(9);case 10:return r.a(2)}},r,null,[[3,8,9,10]])}))()},removeDocument:function(e){var t=this;return _asyncToGenerator(_regenerator().m(function r(){var i,o,a,s,c;return _regenerator().w(function(r){for(;;)switch(r.p=r.n){case 0:if(n.removeDocumentUrl){r.n=1;break}return r.a(2);case 1:return r.p=1,i=t.getSessionId(),r.n=2,fetch(n.removeDocumentUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({itemId:i,documentId:e.documentId})});case 2:if(!(o=r.v).ok){r.n=3;break}(a=t.documents.indexOf(e))>-1&&t.documents.splice(a,1),r.n=5;break;case 3:return r.n=4,o.text();case 4:s=r.v,console.error("Failed to remove document:",o.status,s);case 5:r.n=7;break;case 6:r.p=6,c=r.v,console.error("Remove document error:",c);case 7:return r.a(2)}},r,null,[[1,6]])}))()},formatFileSize:function(e){return e<1024?e+" B":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB"},renderDocumentBar:function(){if(this.documentBar)if(n.sessionDocumentsEnabled){this.documentBar.classList.remove("d-none");for(var e='<div class="ai-chat-doc-bar d-flex flex-wrap align-items-center gap-1 p-2">',t=0;t<this.documents.length;t++){var r=this.documents[t],i=r.fileName||"Document";i.length>20&&(i=i.substring(0,17)+"..."),e+='<span class="badge bg-secondary bg-opacity-25 text-dark d-inline-flex align-items-center gap-1 px-2 py-1" style="font-size: 0.8rem;" title="'+this.escapeHtml(r.fileName||"")+'">',e+='<i class="fa-solid fa-file-lines" style="font-size: 0.7rem;"></i> ',e+=this.escapeHtml(i),e+=' <button type="button" class="btn-close btn-close-sm ms-1" style="font-size: 0.5rem;" data-doc-index="'+t+'" aria-label="Remove"></button>',e+="</span>"}this.isUploading&&(e+='<span class="badge bg-info bg-opacity-25 text-dark d-inline-flex align-items-center gap-1 px-2 py-1" style="font-size: 0.8rem;">',e+='<span class="spinner-border spinner-border-sm" style="width: 0.7rem; height: 0.7rem;"></span> Uploading...',e+="</span>"),e+='<button type="button" class="btn btn-sm btn-outline-secondary rounded-pill ai-chat-doc-add-btn d-inline-flex align-items-center gap-1" style="font-size: 0.75rem; padding: 0.15rem 0.5rem;" title="Attach documents">',e+='<i class="fa-solid fa-paperclip"></i>',0!==this.documents.length||this.isUploading||(e+=" <span>Attach files</span>"),e+="</button>",e+="</div>",this.documentBar.innerHTML=e;for(var o=this,a=this.documentBar.querySelectorAll(".btn-close"),s=0;s<a.length;s++)a[s].addEventListener("click",function(e){return function(t){t.preventDefault(),t.stopPropagation();var n=o.documents[e];n&&o.removeDocument(n)}}(parseInt(a[s].getAttribute("data-doc-index"))));var c=this.documentBar.querySelector(".ai-chat-doc-add-btn");c&&c.addEventListener("click",function(e){e.preventDefault(),o.triggerFileInput()})}else this.documentBar.classList.add("d-none")},escapeHtml:function(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML},startConnection:function(){var e=this;return _asyncToGenerator(_regenerator().m(function t(){var r;return _regenerator().w(function(t){for(;;)switch(t.p=t.n){case 0:return e.connection=(new signalR.HubConnectionBuilder).withUrl(n.signalRHubUrl).withAutomaticReconnect().build(),e.connection.serverTimeoutInMilliseconds=6e5,e.connection.keepAliveIntervalInMilliseconds=15e3,e.connection.on("LoadSession",function(t){var n;e.initializeSession(t.sessionId,!0),e.messages=[],e.documents=t.documents||[],(null!==(n=t.messages)&&void 0!==n?n:[]).forEach(function(t){e.addMessage(t),e.$nextTick(function(){i(t)})})}),e.connection.on("ReceiveError",function(e){console.error("SignalR Error: ",e)}),e.connection.onreconnecting(function(){console.warn("SignalR: reconnecting...")}),e.connection.onreconnected(function(){console.info("SignalR: reconnected.")}),e.connection.onclose(function(t){e.isNavigatingAway||t&&console.warn("SignalR connection closed with error:",t.message||t)}),t.p=1,t.n=2,e.connection.start();case 2:t.n=4;break;case 3:t.p=3,r=t.v,console.error("SignalR Connection Error: ",r);case 4:return t.a(2)}},t,null,[[1,3]])}))()},addMessageInternal:function(e){var t=this;this.fireEvent(new CustomEvent("addingOpenAIPromotMessage",{detail:{message:e}})),this.messages.push(e),this.$nextTick(function(){t.fireEvent(new CustomEvent("addedOpenAIPromotMessage",{detail:{message:e}}))})},addMessage:function(e){var t=this;if(e.content){var n=e.content.trim();if(e.references&&"object"===_typeof(e.references)&&Object.keys(e.references).length){for(var r=0,a=Object.entries(e.references);r<a.length;r++){var s=_slicedToArray(a[r],2),c=s[0],l=s[1];n=n.replaceAll(c,"<sup><strong>".concat(l.index,"</strong></sup>"))}n=n.replaceAll("</strong></sup><sup>","</strong></sup><sup>,</sup><sup>"),n+="<br><br>";for(var d=0,u=Object.entries(e.references);d<u.length;d++){var h=_slicedToArray(u[d],2),f=(h[0],h[1]);n+="**".concat(f.index,"**. [").concat(f.text,"](").concat(f.link,")<br>")}}e.content=n,e.htmlContent=o(n,e)}this.addMessageInternal(e),this.hidePlaceholder(),this.$nextTick(function(){i(e),t.scrollToBottom()})},addMessages:function(e){for(var t=this,n=0;n<e.length;n++)this.addMessageInternal(e[n]);this.hidePlaceholder(),this.$nextTick(function(){t.scrollToBottom()})},hidePlaceholder:function(){this.placeholder&&this.placeholder.classList.add("d-none"),this.isPlaceholderVisible=!1},showPlaceholder:function(){this.placeholder&&this.placeholder.classList.remove("d-none"),this.isPlaceholderVisible=!0},fireEvent:function(e){document.dispatchEvent(e)},isIndicator:function(e){return"indicator"===e.role},sendMessage:function(){var e=this.prompt.trim();e&&(this.addMessage({role:"user",content:e}),this.streamMessage(this.getProfileId(),e,null),this.inputElement.value="",this.prompt="")},streamMessage:function(e,t,n){var r=this;this.stream&&(this.stream.dispose(),this.stream=null),this.streamingStarted(),this.showTypingIndicator(),this.autoScroll=!0;var a="",s={},c=this.messages.length,l=this.getSessionId();this.stream=this.connection.stream("SendMessage",e,t,l,n).subscribe({next:function(e){var t=r.messages[c];if(!t){e.sessionId&&!l&&r.initializeSession(e.sessionId),r.hideTypingIndicator(),c=r.messages.length;var n={role:"assistant",title:e.title,content:"",htmlContent:"",isStreaming:!0};r.messages.push(n),t=n}if(!e.title||t.title&&t.title===e.title||(t.title=e.title),e.references&&"object"===_typeof(e.references)&&Object.keys(e.references).length)for(var d=0,u=Object.entries(e.references);d<u.length;d++){var h=_slicedToArray(u[d],2),f=h[0],g=h[1];s[f]=g}if(e.content){for(var m=e.content,p=0,v=Object.entries(s);p<v.length;p++){var y=_slicedToArray(v[p],2),b=y[0],S=y[1];m=m.replaceAll(b,"<sup><strong>".concat(S.index,"</strong></sup>"))}a+=m.replaceAll("</strong></sup><sup>","</strong></sup><sup>,</sup><sup>")}t.content=a,t.htmlContent=o(a,t),r.messages[c]=t,r.$nextTick(function(){i(t),r.scrollToBottom()})},complete:function(){var e;r.processReferences(s,c),r.streamingFinished();var t=r.messages[c];t&&(t.isStreaming=!1),t&&t.content||r.hideTypingIndicator(),null===(e=r.stream)||void 0===e||e.dispose(),r.stream=null},error:function(e){var t;r.processReferences(s,c),r.streamingFinished();var n=r.messages[c];n&&(n.isStreaming=!1),r.hideTypingIndicator(),r.isNavigatingAway||r.addMessage(r.getServiceDownMessage()),null===(t=r.stream)||void 0===t||t.dispose(),r.stream=null,console.error("Stream error:",e)}})},getServiceDownMessage:function(){return{role:"assistant",content:"Our service is currently unavailable. Please try again later. We apologize for the inconvenience.",htmlContent:""}},processReferences:function(e,t){if(Object.keys(e).length){var n,r=this.messages[t];r.content=(null===(n=r.content)||void 0===n?void 0:n.trim())+"<br><br>"||"";for(var i=0,a=Object.entries(e);i<a.length;i++){var s=_slicedToArray(a[i],2),c=(s[0],s[1]);r.content+="**".concat(c.index,"**. [").concat(c.text,"](").concat(c.link,")<br>")}r.htmlContent=o(r.content,r),this.messages[t]=r,this.scrollToBottom()}},streamingStarted:function(){var e=this.buttonElement.getAttribute("data-stop-icon");e&&(this.buttonElement.innerHTML=e),this.inputElement&&this.inputElement.setAttribute("disabled","disabled")},streamingFinished:function(){var e=this.buttonElement.getAttribute("data-start-icon");if(e&&(this.buttonElement.innerHTML=e),this.inputElement&&(this.inputElement.removeAttribute("disabled"),this.inputElement.focus()),this.chatContainer)for(var t=this.chatContainer.querySelectorAll(".ai-streaming-icon"),n=0;n<t.length;n++)t[n].classList.remove("ai-streaming-icon"),t[n].classList.add("ai-bot-icon");for(n=0;n<this.messages.length;n++)this.messages[n].isStreaming&&(this.messages[n].isStreaming=!1)},generatePrompt:function(e){if(e){var t=e.getAttribute("data-profile-id"),n=this.getSessionId(),r=this.getProfileId();t&&n?this.streamMessage(t,null,r):console.error("The given element is missing data-profile-id or the session has not yet started.")}else console.error("The element paramter is required.")},createSessionUrl:function(e,t,n){var r=e.toLowerCase().startsWith("http")?e:window.location.origin+e,i=new URL(r);return i.searchParams.set(t,n),i.toString()},showTypingIndicator:function(){this.addMessage({role:"indicator",htmlContent:n.indicatorTemplate})},hideTypingIndicator:function(){var e=this.messages.length;return this.messages=this.messages.filter(function(e){return"indicator"!==e.role}),e-this.messages.length},scrollToBottom:function(){var e=this;this.autoScroll&&setTimeout(function(){e.chatContainer.scrollTop=e.chatContainer.scrollHeight-e.chatContainer.clientHeight},50)},handleUserInput:function(e){this.prompt=e.target.value},getProfileId:function(){return this.inputElement.getAttribute("data-profile-id")},setSessionId:function(e){this.inputElement.setAttribute("data-session-id",e||"")},resetSession:function(){this.setSessionId(""),this.isSessionStarted=!1,this.widgetIsInitialized&&localStorage.removeItem(this.chatWidgetStateSession),this.messages=[],this.documents=[],this.showPlaceholder()},initializeApp:function(){var e=this;if(this.inputElement=document.querySelector(n.inputElementSelector),this.buttonElement=document.querySelector(n.sendButtonElementSelector),this.chatContainer=document.querySelector(n.chatContainerElementSelector),this.placeholder=document.querySelector(n.placeholderElementSelector),n.sessionDocumentsEnabled&&n.documentBarSelector&&(this.documentBar=document.querySelector(n.documentBarSelector),this.documentBar)){this.renderDocumentBar();var t=document.createElement("input");t.type="file",t.id="ai-chat-doc-input",t.className="d-none",t.multiple=!0,n.allowedExtensions&&(t.accept=n.allowedExtensions),t.addEventListener("change",function(t){return e.handleFileInputChange(t)}),this.documentBar.parentElement.appendChild(t);var r=this.inputElement?this.inputElement.closest(".ai-admin-widget-input, .text-bg-light"):null;r&&(r.addEventListener("dragover",function(t){return e.handleDragOver(t)}),r.addEventListener("dragleave",function(t){return e.handleDragLeave(t)}),r.addEventListener("drop",function(t){return e.handleDrop(t)}))}this.chatContainer.addEventListener("scroll",function(){if(e.stream){var t=e.chatContainer.scrollHeight-e.chatContainer.clientHeight-e.chatContainer.scrollTop<=30;e.autoScroll=t}}),this.inputElement.addEventListener("keydown",function(t){null==e.stream&&("Enter"!==t.key||t.shiftKey||(t.preventDefault(),e.buttonElement.click()))}),this.inputElement.addEventListener("input",function(t){e.handleUserInput(t),t.target.value.trim()?e.buttonElement.removeAttribute("disabled"):e.buttonElement.setAttribute("disabled",!0)}),this.buttonElement.addEventListener("click",function(){if(null==e.stream)e.sendMessage();else if(e.stream.dispose(),e.stream=null,e.streamingFinished(),e.hideTypingIndicator(),e.messages.length>0){var t=e.messages[e.messages.length-1];"assistant"!==t.role||t.content?t.isStreaming&&(t.isStreaming=!1):e.messages.pop()}});for(var i=document.getElementsByClassName("profile-generated-prompt"),o=0;o<i.length;o++)i[o].addEventListener("click",function(t){t.preventDefault(),e.generatePrompt(t.target)});var a=document.getElementsByClassName("chat-session-history-item");for(o=0;o<a.length;o++)a[o].addEventListener("click",function(t){t.preventDefault();var n=t.target.getAttribute("data-session-id");n?(e.loadSession(n),e.showChatScreen()):console.error("an element with the class chat-session-history-item with no data-session-id set.")});for(var s=0;s<n.messages.length;s++)this.addMessage(n.messages[s]);this.chatContainer&&this.chatContainer.addEventListener("click",function(e){var t=e.target.closest(".ai-code-copy-btn");if(t){var n=t.closest("pre");if(n){var r=n.querySelector("code");r&&navigator.clipboard.writeText(r.textContent)}}})},loadSession:function(e){this.connection.invoke("LoadSession",e).catch(function(e){return console.error(e)})},reloadCurrentSession:function(){var e=this.getSessionId();e&&this.loadSession(e)},initializeSession:function(e,t){this.isSessionStarted&&!t||(this.fireEvent(new CustomEvent("initializingSessionOpenAIChat",{detail:{sessionId:e}})),this.setSessionId(e),this.isSessionStarted=!0,this.widgetIsInitialized&&localStorage.setItem(this.chatWidgetStateSession,e))},initializeWidget:function(){var e=this;if(n.widget.chatWidgetContainer)if(n.widget.chatWidgetStateName){if(document.querySelector(n.widget.chatWidgetContainer)){if(n.widget.chatHistorySection&&(this.chatHistorySection=document.querySelector(n.widget.chatHistorySection)),this.chatWidgetStateName=n.widget.chatWidgetStateName,this.chatWidgetStateSession=n.widget.chatWidgetStateName+"Session",this.widgetIsInitialized=!0,this.reloadCurrentSession(),n.widget.showHistoryButton&&this.chatHistorySection){var t=document.querySelector(n.widget.showHistoryButton);if(t&&t.addEventListener("click",function(){e.chatHistorySection.classList.toggle("show")}),n.widget.closeHistoryButton){var r=document.querySelector(n.widget.closeHistoryButton);r&&r.addEventListener("click",function(){e.showChatScreen()})}}if(n.widget.newChatButton){var i=document.querySelector(n.widget.newChatButton);i&&i.addEventListener("click",function(){e.resetSession(),e.showChatScreen()})}}}else console.error("The widget chatWidgetStateName is required.");else console.error("The widget chatWidgetContainer is required.")},showChatScreen:function(){this.chatHistorySection&&this.chatHistorySection.classList.remove("show")},getSessionId:function(){var e=this.inputElement.getAttribute("data-session-id");return!e&&this.widgetIsInitialized&&(e=localStorage.getItem(this.chatWidgetStateSession)),e},copyResponse:function(e){navigator.clipboard.writeText(e)}},watch:{documents:{handler:function(){this.renderDocumentBar()},deep:!0},isUploading:function(){this.renderDocumentBar()}},mounted:function(){var e=this;_asyncToGenerator(_regenerator().m(function t(){return _regenerator().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,e.startConnection();case 1:e.initializeApp(),n.widget&&e.initializeWidget();case 2:return t.a(2)}},t)}))(),window.addEventListener("beforeunload",this.handleBeforeUnload)},beforeUnmount:function(){window.removeEventListener("beforeunload",this.handleBeforeUnload),this.stream&&(this.stream.dispose(),this.stream=null),this.connection&&this.connection.stop()},template:n.messageTemplate}).mount(n.appElementSelector);console.error("The sendButtonElementSelector is required.")}else console.error("The inputElementSelector is required.");else console.error("The chatContainerElementSelector is required.");else console.error("The appElementSelector is required.");else console.error("The signalRHubUrl is required.")}}}(),window.downloadChart=function(e){var t=document.getElementById(e);if(t){var n=document.createElement("a");n.download="chart-"+e+".png",n.href=t.toDataURL("image/png"),n.click()}else console.error("Chart canvas not found:",e)},document.addEventListener("click",function(e){var t=e.target.closest(".ai-download-image");if(t){var n=t.closest(".generated-image-container"),r=null==n?void 0:n.querySelector("img");if(r){var i=r.src;i&&i.startsWith("data:")&&(e.preventDefault(),fetch(i).then(function(e){return e.blob()}).then(function(e){var n=URL.createObjectURL(e),r=document.createElement("a");r.href=n,r.download=t.getAttribute("download")||"generated-image.png",document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(function(){URL.revokeObjectURL(n)},100)}).catch(function(e){console.error("Failed to download image:",e)}))}}});
