@using CrestApps.OrchardCore.Subscriptions.Core
@using CrestApps.OrchardCore.Subscriptions.Core.Models

@model ShapeViewModel<SubscriptionFlowPaymentMethod>

<script asp-name="subscription-payment-methods"></script>
<script at="Foot" depends-on="subscription-payment-methods">
    document.addEventListener('DOMContentLoaded', () => {
        const payButtonElement = document.getElementById('Subscription_Next_Button');
        payButtonElement.addEventListener('click', (e) => {

            if (payButtonElement.getAttribute('data-method-name') != '@SubscriptionConstants.PayLaterProcessorKey') {
                return;
            }
            e.preventDefault();

            enablePayButtonButton(payButtonElement, false);
            fetch('@Url.RouteUrl(SubscriptionConstants.RouteName.CreatePayLaterEndpoint)', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sessionId: '@(Model.Value.Flow.Session.SessionId)'
                }),
            }).then((response) => response.json())
                .then(data => {
                    const form = document.getElementById('subscription-form');

                    if (data.status == 'completed') {
                        var submitEvent = new Event("submit", {
                            bubbles: true,
                            cancelable: true
                        });
                        if (form.dispatchEvent(submitEvent)) {
                            form.requestSubmit();
                        }
                    } else {
                        enablePayButtonButton(payButtonElement, true);

                        alert('@T["Unexpected error. Please try again."]');
                    }
                });
        });

    });
</script>
