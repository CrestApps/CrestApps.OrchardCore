@using CrestApps.OrchardCore.AI.Workflows.ViewModels
@using CrestApps.OrchardCore.AI.Models
@using OrchardCore

@model AICompletionWithConfigTaskViewModel

<div class="mb-3" asp-validation-class-for="ProviderName">
    <label asp-for="ProviderName" class="form-label">@T["Provider"]</label>
    <select asp-for="ProviderName" class="form-select" asp-items="Model.Providers">
        <option value="">@T["Select a provider"]</option>
    </select>
    <span asp-validation-for="ProviderName"></span>
    <span class="hint">@T["The AI provider to use."]</span>
</div>

<div class="mb-3" asp-validation-class-for="ConnectionName">
    <label asp-for="ConnectionName" class="form-label">@T["Conntection"]</label>
    <select asp-for="ConnectionName" class="form-select" asp-items="Model.ConnectionNames">
        <option value="">@T["Select a connection"]</option>
    </select>
    <span asp-validation-for="ConnectionName"></span>
</div>

<div class="mb-3" asp-validation-class-for="DeploymentName">
    <label asp-for="DeploymentName" class="form-label">@T["Deployment"]</label>
    <select asp-for="DeploymentName" class="form-select" asp-items="Model.DeploymentNames">
        <option value="">@T["Select a deployment"]</option>
    </select>
    <span asp-validation-for="DeploymentName"></span>
</div>

<div class="mb-3" asp-validation-class-for="ResultPropertyName">
    <label asp-for="ResultPropertyName" class="form-label">@T["Result property name"]</label>
    <input asp-for="ResultPropertyName" class="form-control" autofocus="autofocus" />
    <span asp-validation-for="ResultPropertyName"></span>
    <span class="hint">@T["Specifies where the result will be stored. Prefix the Result Property Name with AI- to avoid conflicts. This allows access to the AI Chat Response in subsequent workflow tasks."]</span>
</div>

<div class="mb-3" asp-validation-class-for="PromptTemplate">
    <label asp-for="PromptTemplate" class="form-label">@T["Prompt template"]</label>
    <input type="text" asp-for="PromptTemplate" class="form-control code" />
    <span asp-validation-for="PromptTemplate"></span>
    <span class="hint">@T["This template is used to generate the prompt for the AI model. You can structure the prompt using Liquid syntax and seamlessly combine existing variables with placeholders like <code>{0}</code>.", "profile"]</span>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="SystemMessage" class="@Orchard.GetLabelClasses()">@T["System instructions"]</label>
    <div class="@Orchard.GetEndClasses()">
        <div class="hint mb-1">@T["The system instruction sets the AI's behavior and response style, guiding how it interacts in a conversation."]</div>
        <textarea asp-for="SystemMessage" class="form-control content-preview-text" rows="5"></textarea>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="MaxTokens" class="@Orchard.GetLabelClasses()">@T["Max response"]</label>
    <div class="@Orchard.GetEndClasses()">
        <input type="number" class="form-control" asp-for="MaxTokens" step="4" min="4">
        <span class="hint">@T["Set a limit on the number of tokens per model response. The supported number of tokens are shared between the prompt (including system message, examples, message history, and user query) and the model's response. One token is roughly 4 characters for typical English text."]</span>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="Temperature" class="@Orchard.GetLabelClasses()">@T["Temperature"]</label>
    <div class="@Orchard.GetEndClasses()">
        <input type="number" class="form-control" asp-for="Temperature" step="0.01" min="0" max="1">
        <span class="hint">@T["Controls randomness. Lowering the temperature means that the model will produce more repetitive and deterministic responses. Increasing the temperature will result in more unexpected or creative responses. Try adjusting temperature or Top P but not both."]</span>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="TopP" class="@Orchard.GetLabelClasses()">@T["Top P"]</label>
    <div class="@Orchard.GetEndClasses()">
        <input type="number" class="form-control" asp-for="TopP" step="0.01" min="0" max="1">
        <span class="hint">@T["Similar to temperature, this controls randomness but uses a different method. Lowering Top P will narrow the model's token selection to likelier tokens. Increasing Top P will let the model choose from tokens with both high and low likelihood. Try adjusting temperature or Top P but not both."]</span>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="FrequencyPenalty" class="@Orchard.GetLabelClasses()">@T["Frequency penalty"]</label>
    <div class="@Orchard.GetEndClasses()">
        <input type="number" class="form-control" asp-for="FrequencyPenalty" step="0.01" min="0" max="1">
        <span class="hint">@T["Reduce the chance of repeating a token proportionally based on how often it has appeared in the text so far. This decreases the likelihood of repeating the exact same text in a response."]</span>
    </div>
</div>

<div class="@Orchard.GetWrapperClasses()">
    <label asp-for="PresencePenalty" class="@Orchard.GetLabelClasses()">@T["Presence penalty"]</label>
    <div class="@Orchard.GetEndClasses()">
        <input type="number" class="form-control" asp-for="PresencePenalty" step="0.01" min="0" max="1">
        <span class="hint">@T["Reduce the chance of repeating any token that has appeared in the text at all so far. This increases the likelihood of introducing new topics in a response."]</span>
    </div>
</div>

<style asp-name="codemirror"></style>
<style asp-name="easymde"></style>
<style at="Head">
    .cm-editor-readonly {
        background-color: var(--bs-secondary-bg, '#e9ecef') !important;
    }
</style>

<script asp-name="easymde" at="Foot"></script>
<script at="Foot" depends-on="easymde">
    document.addEventListener('DOMContentLoaded', function () {
        const isRtl = @(Orchard.IsRightToLeft() ? "true" : "false");

        const systemMessageElement = document.getElementById("@Html.IdFor(m => m.SystemMessage)");
        var mde = new EasyMDE({
            element: systemMessageElement,
            forceSync: true,
            autoDownloadFontAwesome: false
        });

        mde.codemirror.on('change', function () {
            document.dispatchEvent(new Event('contentpreview:render'));
        });

        if (isRtl) {
            var toolbarEditors = document.querySelectorAll('.editor-toolbar');

            for (var i = 0; i < toolbarEditors.length; i++)
            {
                toolbarEditors[i].style.direction = 'rtl';
                toolbarEditors[i].style.textAlign = 'right';
            }

            var mirrorContainers = document.querySelectorAll('.CodeMirror');

            for (var i = 0; i < mirrorContainers.length; i++)
            {
                mirrorContainers[i].style.textAlign = 'right';
            }
        }
    });
</script>
