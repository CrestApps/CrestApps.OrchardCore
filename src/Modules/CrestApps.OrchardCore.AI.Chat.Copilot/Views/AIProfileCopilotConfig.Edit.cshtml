@using CrestApps.OrchardCore.AI.Chat.Copilot.ViewModels
@using OrchardCore
@using CrestApps.OrchardCore.AI.Chat.Copilot

@model EditCopilotProfileViewModel

<div class="d-none orchestrator-dependent orchestrator-dependent-copilot">
    <fieldset class="@Orchard.GetWrapperClasses()">
        <legend class="@Orchard.GetLabelClasses()">@T["Copilot Configuration"]</legend>
        <div class="@Orchard.GetEndClasses()">

            @* GitHub Authentication Section *@
            <div class="mb-3">
                <label class="form-label">@T["GitHub Authentication"]</label>
                @if (Model.IsAuthenticated)
                {
                    <div class="alert alert-success d-flex align-items-center justify-content-between py-2">
                        <span>
                            <i class="fas fa-check-circle"></i>
                            @T["Connected as"] <strong>@Model.GitHubUsername</strong>
                        </span>
                        <a href="#" class="btn btn-sm btn-outline-danger ms-2" id="ap-disconnect-github" data-confirm-message="@T["Are you sure you want to disconnect your GitHub account?"]">
                            <i class="fa-solid fa-power-off"></i>
                        </a>
                    </div>
                    <div class="alert alert-warning py-2">
                        <i class="fas fa-exclamation-triangle"></i>
                        @T["Using the Copilot orchestrator will allow any user chatting with this AI Profile to utilize your GitHub credentials, not their own."]
                    </div>
                }
                else
                {
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        @T["Copilot requires GitHub authentication. Sign in with your GitHub account to continue."]
                    </div>
                    <a href="#" class="btn btn-primary" id="ap-connect-github">
                        <i class="fab fa-github"></i> @T["Sign in with GitHub"]
                    </a>
                }
                <span class="hint">@T["GitHub OAuth is required for Copilot. Your access token will be securely stored and reused across sessions."]</span>
            </div>

            @* Copilot Model Selection *@
            <div class="mb-3">
                <label asp-for="CopilotModel" class="form-label">@T["Copilot Model"]</label>
                <select asp-for="CopilotModel" asp-items="Model.AvailableModels" class="form-select">
                </select>
                <span asp-validation-for="CopilotModel" class="text-danger"></span>
                <span class="hint">@T["Select the Copilot model to use for this profile."]</span>
            </div>

            @* Copilot Flags *@
            <div class="mb-3">
                <label asp-for="CopilotFlags" class="form-label">@T["Copilot Flags"]</label>
                <input asp-for="CopilotFlags" class="form-control" placeholder="--allow-all" />
                <span asp-validation-for="CopilotFlags" class="text-danger"></span>
                <span class="hint">@T["Optional Copilot execution flags (e.g., --allow-all). Separate multiple flags with spaces."]</span>
            </div>
        </div>
    </fieldset>
</div>

<script at="Foot">
    document.addEventListener('DOMContentLoaded', function () {
        const connectButton = document.getElementById('ap-connect-github');
        const disconnectButton = document.getElementById('ap-disconnect-github');

        // Auto-select the first available model if none is selected.
        const copilotModelSelect = document.getElementById('@Html.IdFor(m => m.CopilotModel)');
        if (copilotModelSelect && !copilotModelSelect.value) {
            const firstOption = copilotModelSelect.querySelector('option[value]:not([value=""])');
            if (firstOption) {
                copilotModelSelect.value = firstOption.value;
            }
        }

        if (connectButton) {
            connectButton.addEventListener('click', function(e) {
                e.preventDefault();

                // Open GitHub OAuth in a popup to avoid navigating away from the form.
                var authUrl = '@Url.Action("AuthorizeGitHub", "CopilotAuth", new { area = "CrestApps.OrchardCore.AI.Chat.Copilot" })' + '?returnUrl=__popup__';
                var popup = window.open(authUrl, 'github-oauth', 'width=600,height=700,scrollbars=yes,resizable=yes');

                // Listen for the popup to complete authentication.
                window.addEventListener('message', function handler(event) {
                    if (event.origin !== window.location.origin) return;
                    if (event.data && event.data.type === 'github-auth-complete') {
                        window.removeEventListener('message', handler);

                        // Refresh the page to reload auth state and available models.
                        window.location.reload();
                    }
                });
            });
        }

        if (disconnectButton) {
            const confirmMessage = disconnectButton.getAttribute('data-confirm-message');
            disconnectButton.addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm(confirmMessage)) {
                    // Create and submit a form for POST with antiforgery token
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '@Url.Action("DisconnectGitHub", "CopilotAuth", new { area = "CrestApps.OrchardCore.AI.Chat.Copilot" })';

                    // Add antiforgery token
                    const token = document.querySelector('input[name="__RequestVerificationToken"]');
                    if (token) {
                        const tokenInput = document.createElement('input');
                        tokenInput.type = 'hidden';
                        tokenInput.name = '__RequestVerificationToken';
                        tokenInput.value = token.value;
                        form.appendChild(tokenInput);
                    }

                    // Return to same page after disconnect
                    const returnUrlInput = document.createElement('input');
                    returnUrlInput.type = 'hidden';
                    returnUrlInput.name = 'returnUrl';
                    returnUrlInput.value = window.location.pathname + window.location.search;
                    form.appendChild(returnUrlInput);

                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }
    });
</script>
