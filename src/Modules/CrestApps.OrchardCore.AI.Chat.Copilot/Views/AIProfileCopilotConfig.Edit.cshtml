@using CrestApps.OrchardCore.AI.Chat.Copilot.Models
@using CrestApps.OrchardCore.AI.Chat.Copilot.ViewModels
@using OrchardCore
@using CrestApps.OrchardCore.AI.Chat.Copilot

@model EditCopilotProfileViewModel

<div class="d-none orchestrator-dependent orchestrator-dependent-copilot">
    <fieldset class="@Orchard.GetWrapperClasses()">
        <legend class="@Orchard.GetLabelClasses()">@T["Copilot Configuration"]</legend>
        <div class="@Orchard.GetEndClasses()">

            @if (Model.AuthenticationType == CopilotAuthenticationType.GitHubOAuth)
            {
                @* GitHub Authentication Section — toggled dynamically via JS *@
                <div class="mb-3">
                    <label class="form-label">@T["GitHub Authentication"]</label>

                    @* Connected state *@
                    <div id="ap-github-connected" class="@(Model.IsAuthenticated ? "" : "d-none")">
                        <div class="alert alert-success d-flex align-items-center justify-content-between py-2">
                            <span>
                                <i class="fas fa-check-circle"></i>
                                @T["Connected as"] <strong id="ap-github-username">@Model.GitHubUsername</strong>
                            </span>
                            <a href="#" class="btn btn-sm btn-outline-danger ms-2" id="ap-disconnect-github" data-confirm-message="@T["Are you sure you want to disconnect your GitHub account?"]">
                                <i class="fa-solid fa-power-off"></i>
                            </a>
                        </div>
                        <div class="alert alert-warning py-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            @T["Using the Copilot orchestrator will allow any user chatting with this AI Profile to utilize your GitHub credentials, not their own."]
                        </div>
                    </div>

                    @* Disconnected state *@
                    <div id="ap-github-disconnected" class="@(Model.IsAuthenticated ? "d-none" : "")">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            @T["Copilot requires GitHub authentication. Sign in with your GitHub account to continue."]
                        </div>
                        <a href="#" class="btn btn-primary" id="ap-connect-github">
                            <i class="fab fa-github"></i> @T["Sign in with GitHub"]
                        </a>
                    </div>

                    @* Loading state *@
                    <div id="ap-github-loading" class="d-none">
                        <div class="d-flex align-items-center text-muted py-2">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            @T["Checking GitHub connection..."]
                        </div>
                    </div>

                    <span class="hint">@T["GitHub OAuth is required for Copilot. Your access token will be securely stored and reused across sessions."]</span>
                </div>

                @* Copilot Model Selection — dropdown from GitHub API *@
                <div class="mb-3">
                    <label asp-for="CopilotModel" class="form-label">@T["Copilot Model"]</label>
                    <select asp-for="CopilotModel" asp-items="Model.AvailableModels" class="form-select">
                    </select>
                    <span asp-validation-for="CopilotModel" class="text-danger"></span>
                    <span class="hint">@T["Select the Copilot model to use for this profile."]</span>
                </div>
            }
            else
            {
                @* BYOK mode — model is a text input (user specifies model name manually) *@
                <div class="mb-3">
                    <label asp-for="CopilotModel" class="form-label">@T["Model Override"]</label>
                    <input asp-for="CopilotModel" class="form-control" placeholder="@T["Leave empty to use the default model from settings"]" />
                    <span asp-validation-for="CopilotModel" class="text-danger"></span>
                    <span class="hint">@T["Optionally override the model name for this profile. Leave empty to use the default model configured in Copilot settings."]</span>
                </div>
            }

            @* Allow All *@
            <div class="mb-3">
                <div class="form-check">
                    <input asp-for="IsAllowAll" class="form-check-input" type="checkbox" />
                    <label asp-for="IsAllowAll" class="form-check-label">@T["Allow all tool executions"]</label>
                </div>
                <span class="hint">@T["When checked, the Copilot CLI runs with the --allow-all flag, permitting all tool executions without confirmation."]</span>
            </div>
        </div>
    </fieldset>
</div>

@if (Model.AuthenticationType == CopilotAuthenticationType.GitHubOAuth)
{
<script at="Foot">
    document.addEventListener('DOMContentLoaded', function () {
        const connectButton = document.getElementById('ap-connect-github');
        const disconnectButton = document.getElementById('ap-disconnect-github');
        const connectedEl = document.getElementById('ap-github-connected');
        const disconnectedEl = document.getElementById('ap-github-disconnected');
        const loadingEl = document.getElementById('ap-github-loading');
        const usernameEl = document.getElementById('ap-github-username');
        const modelSelect = document.getElementById('@Html.IdFor(m => m.CopilotModel)');

        const statusUrl = '@Url.Action("GetAuthStatus", "CopilotAuth", new { area = "CrestApps.OrchardCore.AI.Chat.Copilot" })';
        const modelsUrl = '@Url.Action("GetModels", "CopilotAuth", new { area = "CrestApps.OrchardCore.AI.Chat.Copilot" })';
        const disconnectUrl = '@Url.Action("DisconnectGitHubAjax", "CopilotAuth", new { area = "CrestApps.OrchardCore.AI.Chat.Copilot" })';
        const authUrl = '@Url.Action("AuthorizeGitHub", "CopilotAuth", new { area = "CrestApps.OrchardCore.AI.Chat.Copilot" })' + '?returnUrl=__popup__';

        function getAntiForgeryToken() {
            const tokenEl = document.querySelector('input[name="__RequestVerificationToken"]');
            return tokenEl ? tokenEl.value : '';
        }

        function showState(state) {
            connectedEl.classList.toggle('d-none', state !== 'connected');
            disconnectedEl.classList.toggle('d-none', state !== 'disconnected');
            loadingEl.classList.toggle('d-none', state !== 'loading');
        }

        async function loadModels() {
            try {
                const currentValue = modelSelect.value;
                const resp = await fetch(modelsUrl);
                const models = await resp.json();

                modelSelect.innerHTML = '';
                models.forEach(function (m) {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.name;
                    modelSelect.appendChild(opt);
                });

                // Restore previous selection if still available, otherwise pick first.
                if (currentValue && modelSelect.querySelector('option[value="' + CSS.escape(currentValue) + '"]')) {
                    modelSelect.value = currentValue;
                } else if (modelSelect.options.length > 0) {
                    modelSelect.selectedIndex = 0;
                }
            } catch (e) {
                console.error('Failed to load Copilot models', e);
            }
        }

        // Auto-select the first available model if none is selected.
        if (modelSelect && !modelSelect.value) {
            const firstOption = modelSelect.querySelector('option[value]:not([value=""])');
            if (firstOption) {
                modelSelect.value = firstOption.value;
            }
        }

        if (connectButton) {
            connectButton.addEventListener('click', function (e) {
                e.preventDefault();

                var popup = window.open(authUrl, 'github-oauth', 'width=600,height=700,scrollbars=yes,resizable=yes');

                window.addEventListener('message', function handler(event) {
                    if (event.origin !== window.location.origin) return;
                    if (event.data && event.data.type === 'github-auth-complete') {
                        window.removeEventListener('message', handler);

                        if (event.data.success) {
                            // Update DOM without reloading.
                            usernameEl.textContent = event.data.username;
                            showState('connected');
                            loadModels();
                        }
                    }
                });
            });
        }

        if (disconnectButton) {
            const confirmMessage = disconnectButton.getAttribute('data-confirm-message');
            disconnectButton.addEventListener('click', async function (e) {
                e.preventDefault();
                if (!confirm(confirmMessage)) return;

                showState('loading');
                try {
                    const resp = await fetch(disconnectUrl, {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': getAntiForgeryToken(),
                        },
                    });
                    if (resp.ok) {
                        showState('disconnected');
                    } else {
                        showState('connected');
                    }
                } catch {
                    showState('connected');
                }
            });
        }
    });
</script>
}
